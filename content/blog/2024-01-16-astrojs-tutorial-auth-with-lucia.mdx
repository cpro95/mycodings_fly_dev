---
slug: 2024-01-16-astrojs-tutorial-auth-with-lucia
title: astrojs ê°•ì¢Œ 11í¸. astrojsì™€ luciaë¥¼ ì´ìš©í•´ì„œ ìœ ì € ì¸ì¦ êµ¬í˜„
date: 2024-01-16T12:02:52.771Z
description: Lucia authë¥¼ ì´ìš©í•´ì„œ Astrojsì—ì„œ ìœ ì € ê°€ì…í•˜ê¸°, ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒ êµ¬í˜„í•˜ê¸°
meta:
  keywords:
    - astrojs
    - auth
    - lucia
published: true
---

# astrojs ê°•ì¢Œ 11í¸. astrojsì™€ luciaë¥¼ ì´ìš©í•´ì„œ ìœ ì € ì¸ì¦ êµ¬í˜„

ì•ˆë…•í•˜ì„¸ìš”?

ì˜¤ëŠ˜ì€ AstroJS ê°•ì¢Œ 11í¸ì„ ì§„í–‰í•´ ë³¼ê¹Œ í•©ë‹ˆë‹¤.

ì§€ë‚œ ì‹œê°„ì— ì¿ í‚¤ì™€ í† í°ì„ ì´ìš©í•œ ìœ ì € ë¡œê·¸ì¸ì„ êµ¬í˜„í–ˆì—ˆëŠ”ë°ìš”.

ì˜¤ëŠ˜ì€ ë˜‘ê°™ì€ ê±¸ Luciaë¥¼ ì´ìš©í•´ì„œ êµ¬í˜„í•´ ë³¼ê¹Œ í•©ë‹ˆë‹¤.

ì „ì²´ astrojs ê°•ì¢Œ ëª©ë¡ì…ë‹ˆë‹¤.

1. [astrojs ê°•ì¢Œ 1í¸. astrojsì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°](https://mycodings.fly.dev/blog/2023-10-07-astrojs-tutorial-how-to-handle-data-in-astrojs)

2. [astrojs ê°•ì¢Œ 2í¸. React ì“°ì§€ ì•Šê³  ìˆœìˆ˜ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ Dark Mode ë§Œë“œëŠ” ë²•](https://mycodings.fly.dev/blog/2023-10-14-astrojs-tutorial-clean-build-of-darkmode-theme)

3. [astrojs ê°•ì¢Œ 3í¸. ì›¹ ì»´í¬ë„ŒíŠ¸ë¡œ ì§ì ‘ ì•„ì¼ëœë“œ ì•„í‚¤í…ì²˜ êµ¬í˜„í•´ ë³´ê¸°](https://mycodings.fly.dev/blog/2023-10-14-understanding-astosjs-island-architecture-from-making-my-own-island-web-component)

4. [astrojs ê°•ì¢Œ 4í¸. astrojs ì•„ì¼ëœë“œ ì•„í‚¤í…ì²˜ ì™„ë²½ ë¶„ì„](https://mycodings.fly.dev/blog/2023-10-21-astrojs-in-depth-review-component-island-architecture)

5. [astrojs ê°•ì¢Œ 5í¸. astrojs ë¼ìš°íŒ… ì™„ë²½ ë¶„ì„(routing, dynamic routing)](https://mycodings.fly.dev/blog/2023-10-29-astrojs-all-about-routing-and-dynamic-routing)

6. [astrojs ê°•ì¢Œ 6í¸. astrojs Content Collectionê³¼ ë‹¤ì´ë‚´ë¯¹ ë¼ìš°íŒ… ì ‘ëª©í•˜ê¸°](https://mycodings.fly.dev/blog/2023-10-29-astrojs-howto-use-content-collection-and-dynamic-routing)

7. [astrojs ê°•ì¢Œ 7í¸. astrojs Server Side Rendering(SSR) ì™„ë²½ ë¶„ì„](https://mycodings.fly.dev/blog/2023-10-30-astrojs-howto-use-ssr-in-astrojs-server-side-rendering)

8. [astrojs ê°•ì¢Œ 8í¸. astrojsì™€ firebaseë¡œ ìœ ì € ë¡œê·¸ì¸ êµ¬í˜„](https://mycodings.fly.dev/blog/2023-11-08-astrojs-how-to-ssr-with-firebase-user-session)

9. [astrojs ê°•ì¢Œ 9í¸. astrojsì™€ supabaseë¡œ ìœ ì € ë¡œê·¸ì¸ êµ¬í˜„](https://mycodings.fly.dev/blog/2023-11-09-astrojs-howto-supabase-authentication-with-ssr)

10. [astrojs ê°•ì¢Œ 10í¸. astrojsì—ì„œ ì¿ í‚¤ì™€ í† í°ì„ ì´ìš©í•´ì„œ ìœ ì € ë¡œê·¸ì¸ êµ¬í˜„](https://mycodings.fly.dev/blog/2024-01-02-astrojs-auth-user-login-by-cookie-with-jwt-token)

11. [astrojs ê°•ì¢Œ 11í¸. astrojsì™€ luciaë¥¼ ì´ìš©í•´ì„œ ìœ ì € ì¸ì¦ êµ¬í˜„](https://mycodings.fly.dev/blog/2024-01-16-astrojs-tutorial-auth-with-lucia)

---

** ëª© ì°¨ **

* 1. [Lucia ì†Œê°œ](#Lucia)

* 2. [Lucia ì¸ì¦ ë°©ì‹](#Lucia-1)

* 3. [AstroJS í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°](#AstroJS)

* 4. [Prisma ì„¤ì •](#Prisma)

* 5. [Model ì„¤ì •](#Model)

* 6. [Lucia ì„¤ì¹˜ ë° ì½”ë“œ ì‘ì„±](#Lucia-1)

	* 6.1. [lucia.ts íŒŒì¼ ë§Œë“¤ê¸°](#lucia.ts)
	
	* 6.2. [lucia ê´€ë ¨ íƒ€ì… env.d.ts ì„¤ì •](#luciaenv.d.ts)
	
	* 6.3. [middlewareë¥¼ ì´ìš©í•´ì„œ auth ê°ì²´ ì „ì—­í™” ì‹œí‚¤ê¸°](#middlewareauth)
	
* 7. [AstroJSì˜ Layout í˜ì´ì§€ ë§Œë“¤ê¸°](#AstroJSLayout)

* 8. [Signup í˜ì´ì§€ ë§Œë“¤ê¸°](#Signup)

* 9. [login í˜ì´ì§€ ë§Œë“¤ê¸°](#login)

* 10. [Dashboard í˜ì´ì§€ ì„¤ì •](#Dashboard)

* 11. [logout êµ¬í˜„](#logout)
  
---

##  1. <a name='Lucia'></a>Lucia ì†Œê°œ

í’€ìŠ¤íƒ ê°œë°œì— ìˆì–´ ê°€ì¥ ì¤‘ìš”í•œ ê²Œ Auth ë¶€ë¶„ì¸ë°ìš”.

Next.jsëŠ” ê·¸ ìœ ëª…í•œ NextAuthê°€ ìˆìŠµë‹ˆë‹¤.

Remix ì§„ì˜ì—ë„ RemixAuthê°€ ìˆëŠ”ë°ìš”.

AstroJSë¥¼ ì§€ì›í•˜ëŠ” Auth ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë³„ë¡œ ì—†ëŠ”ë°ìš”.

LuciaëŠ” AstroJS, Next.js, Nuxtjs, SvelteKit ë“± ì—¬ëŸ¬ ê°€ì§€ì˜ í”„ë ˆì„ì›Œí¬ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ ìœ ì €ë„¤ì„ + íŒ¨ìŠ¤ì›Œë“œ ë°©ì‹ë¿ ì•„ë‹ˆë¼ OAuthë„ ì§€ì›í•©ë‹ˆë‹¤.

ë‹¹ì—°íˆ Typescriptë¥¼ ì§€ì›í•˜ê³  ìˆì–´ íƒ€ì…ì•ˆì •ì„±ì„ ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë°ì´í„°ë² ì´ìŠ¤ëŠ” Adapter ë°©ì‹ì„ ì´ìš©í•˜ê³  ìˆì–´ ì—¬ëŸ¬ ì¢…ë¥˜ì˜ DBì— ëŒ€í•œ ì½”ë“œëŠ” ê³µì‹ í™ˆí˜ì´ì§€ì— ìˆìœ¼ë‹ˆ ì°¸ê³  ë°”ëë‹ˆë‹¤.

LuciaëŠ” ì„¸ì…˜ ê¸°ë°˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì—ëŠ” ì„¸ì…˜ì •ë³´ë¥¼ ì €ì¥í•˜ê³ , í•´ë‹¹ ì„¸ì…˜ì˜ IDëŠ” ì¿ í‚¤ì— ì €ì¥í•˜ì—¬ ê´€ë¦¬í•©ë‹ˆë‹¤.

ê·¸ë˜ì„œ ë°ì´í„°ë² ì´ìŠ¤ëŠ” Prismaë¥¼ ì´ìš©í•  ê±°ê³ , íƒ€ì… ì •í•©ì„± ê²€ì‚¬ëŠ” Zodì— ë§¡ê¸¸ ì˜ˆì •ì…ë‹ˆë‹¤.

---

##  2. <a name='Lucia-1'></a>Lucia ì¸ì¦ ë°©ì‹

ë¨¼ì €, ì‚¬ìš©ì ê°€ì…ì„ ì™„ë£Œí–ˆë‹¤ê³  ì „ì œí–ˆì„ ë•Œ, Luciaì˜ ì „ì²´ì ì¸ íë¦„ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

1. ë¡œê·¸ì¸ í™”ë©´ì—ì„œ ìœ ì €ë„¤ì„ê³¼ íŒ¨ìŠ¤ì›Œë“œë¡œ ë¡œê·¸ì¸ Post ë¦¬í€˜ìŠ¤íŠ¸ ì „ì†¡.

2. Post ë¦¬í€˜ìŠ¤íŠ¸ì™€ ê°™ì´ ë„˜ì–´ì˜¨ ìœ ì €ë„¤ì„ê³¼ íŒ¨ìŠ¤ì›Œë“œì— ë§ëŠ” ìœ ì €ê°€ ì¡´ì¬í•˜ëŠ”ì§€ ì„œë²„ ì¸¡ì—ì„œ í™•ì¸

3. ë§Œì•½ ìœ ì €ê°€ ì¡´ì¬í•œë‹¤ë©´, ì„¸ì…˜ ë°ì´í„°ë¥¼ ë§Œë“¤ì–´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê³ , ë§Œë“¤ì–´ì§„ ì„¸ì…˜ ë°ì´í„°ì— ìˆëŠ” ì„¸ì…˜ IDë¥¼ ì¿ í‚¤ë¥¼ í†µí•´ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ìª½ì—ì„œ ì €ì¥í•©ë‹ˆë‹¤. (ì´ê²Œ ë¡œê·¸ì¸ì´ ì™„ë£Œëë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.)

4. ê° í˜ì´ì§€ì—ì„œ ì„¸ì…˜ì„ ê²€ì¦í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ë¥¼ êµ¬ì¶•í•˜ì—¬ ìœ ì €ì˜ ì„¸ì…˜ ì •ë³´ì— ë”°ë¼ ì ‘ê·¼ ê°€ëŠ¥í•œ í˜ì´ì§€ì™€ ì ‘ê·¼ ë¶ˆê°€ëŠ¥í•œ í˜ì´ì§€ë¥¼ êµ¬ë¶„í•˜ì—¬ ëŒ€ì‘.

5. ì„¸ì…˜ ê²€ì¦ ë°©ì‹ì€ ì¿ í‚¤ì— ì €ì¥ëœ ì„¸ì…˜ IDë¥¼ êº¼ë‚´ ë°ì´í„°ë² ì´ìŠ¤ì— ìˆëŠ” ì„¸ì…˜ì„ íšë“í•˜ê³ ,

6. ì´ë ‡ê²Œ íšë“í•œ ì„¸ì…˜ì˜ ìœ íš¨ê¸°ê°„ì„ ì²´í¬í•¨. ìœ íš¨ê¸°ê°„ì—ëŠ” activePeriodì™€ idlePeriod 2ê°œì˜ ìœ íš¨ê¸°ê°„ìœ¼ë¡œ ê´€ë¦¬ë˜ëŠ”ë°, activePeriodì˜ ê¸°í•œì´ ë§Œë£Œë˜ì–´ë„ idlePeriod ê¸°í•œë‚´ì´ë©´ ì„¸ì…˜ì˜ ìœ íš¨ê¸°ê°„ì„ ë¦¬ì…‹í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì ‘ê·¼. ë³´í†µ activePeriodëŠ” 1ì¼ì´ê³ , idlePeriodëŠ” 2ì£¼ê°„ì˜ ìœ íš¨ê¸°ê°„ì„ ê°€ì§‘ë‹ˆë‹¤.

7.ìµœì¢…ì ìœ¼ë¡œ idlePeriodê°€ ë§Œë£Œë˜ë©´ í•´ë‹¹ ì¸ì¦ì€ ì¢…ë£Œë©ë‹ˆë‹¤. ë˜í•œ ì¿ í‚¤ê°€ ë§Œë£Œë˜ì–´ë„ ì¸ì¦ì´ ì¢…ë£Œë˜ëŠ”ë°ìš”. ì¿ í‚¤ ë§Œë£ŒëŠ” ê¸°ë³¸ì ìœ¼ë¡œ idlePeriod ìœ íš¨ê¸°ê´€ê³¼ ë™ì¼í•©ë‹ˆë‹¤.

8. ì˜ë„ì ìœ¼ë¡œ ì¸ì¦ì„ ì¢…ë£Œí•˜ê³  ì‹¶ì€ ê²½ìš° API ì—”ë“œí¬ì¸íŠ¸ ê°™ì€ ê±¸ ë§Œë“¤ì–´ì„œ Post ë¦¬í€˜ìŠ¤íŠ¸ë¡œ ì„¸ì…˜ì„ ë¬´íš¨í™”í•˜ê±°ë‚˜ ì¿ í‚¤ë¥¼ ì‚­ì œí•˜ëŠ” ì½”ë“œë¥¼ ë§Œë“¤ë©´ ë˜ëŠ”ë°, ê·¸ê²Œ logoutì´ ë©ë‹ˆë‹¤.

---

##  3. <a name='AstroJS'></a>AstroJS í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°

AstroëŠ” 'npm create'ë¥¼ ì§€ì›í•˜ê³  ìˆì–´ ì•„ì£¼ ì‰½ê²Œ í”„ë¡œì íŠ¸ í…œí”Œë¦¿ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
npm create astro@latest astro-lucia
Need to install the following packages:
  create-astro@4.7.1
Ok to proceed? (y)

 astro   Launch sequence initiated.

      â—¼  dir Using astro-lucia as project directory

  tmpl   How would you like to start your new project?
         Empty

  deps   Install dependencies?
         Yes

    ts   Do you plan to write TypeScript?
         Yes

   use   How strict should TypeScript be?
         Strict

   git   Initialize a new git repository?
         Yes

      âœ”  Project initialized!
         â–  Template copied
         â–  Dependencies installed
         â–  TypeScript customized
         â–  Git initialized

  next   Liftoff confirmed. Explore your project!

         Enter your project directory using cd ./astro-lucia
         Run npm run dev to start the dev server. CTRL+C to stop.
         Add frameworks like react or tailwind using astro add.

         Stuck? Join us at https://astro.build/chat

â•­â”€â”€â”€â”€â”€â•®  Houston:
â”‚ â—  â—¡ â—   Good luck out there, astronaut! ğŸš€
â•°â”€â”€â”€â”€â”€â•¯
âœ  cd astro-lucia
```

---

##  4. <a name='Prisma'></a>Prisma ì„¤ì •

Prismaë¥¼ ì„¤ì¹˜í•˜ê³ ,

```bash
npm install prisma --save-dev
```

Prisma ì´ˆê¸°í™”ëŠ” ì•„ë˜ ëª…ë ¹ì–´ë¡œ ì‹¤í–‰í•˜ë©´ ë©ë‹ˆë‹¤.

```bash
npx prisma init --datasource-provider sqlite

âœ” Your Prisma schema was created at prisma/schema.prisma
  You can now open it in your favorite editor.

warn You already have a .gitignore file. Don't forget to add `.env` in it to not commit any private information.

Next steps:
1. Set the DATABASE_URL in the .env file to point to your existing database. If your database has no tables yet, read https://pris.ly/d/getting-started
2. Run prisma db pull to turn your database schema into a Prisma schema.
3. Run prisma generate to generate the Prisma Client. You can then start querying your database.

More information in our documentation:
https://pris.ly/d/getting-started
```

ìœ„ì™€ ê°™ì´ ì´ˆê¸°í™”í•˜ë©´ prisma ë””ë ‰í† ë¦¬ì™€ '.env' íŒŒì¼ì´ ìƒì„±ë©ë‹ˆë‹¤.

prisma ë””ë ‰í† ë¦¬ì—ëŠ” schema.prisma íŒŒì¼ì´ ìë™ì ìœ¼ë¡œ ìƒê¸¸ ê²ë‹ˆë‹¤.

í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ê°œë°œ ì„œë²„ë¥¼ ê¾¸ë¦´ ì˜ˆì •ì´ë¼ Sqlite3ë¥¼ ì´ìš©í–ˆìŠµë‹ˆë‹¤.

---

##  5. <a name='Model'></a>Model ì„¤ì •

Luciaë¥¼ ì´ìš©í•œ ì„¸ì…˜ ê´€ë¦¬ë¥¼ ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ ìµœì†Œí•œì˜ ëª¨ë¸ë¡œ ì„¤ì •í•˜ê² ìŠµë‹ˆë‹¤.

```bash
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @unique
  auth_session Session[]
  key          Key[]
}

model Session {
  id             String @id @unique
  user_id        String
  active_expires BigInt
  idle_expires   BigInt
  user           User   @relation(references: [id], fields: [user_id], onDelete: Cascade)

  @@index([user_id])
}

model Key {
  id              String  @id @unique
  hashed_password String?
  user_id         String
  user            User    @relation(references: [id], fields: [user_id], onDelete: Cascade)
  @@index([user_id])
}
```

Luciaì—ì„œ ì‚¬ìš©í•  ëª¨ë¸ì€ User, Session, Keyë¡œ ë˜ì–´ ìˆê³ , ìµœì‹  íŠ¸ë Œë“œì— ë”°ë¼ Userì™€ Key ë¶€ë¶„ì„ ë”°ë¡œ ë¶„ë¦¬í–ˆìŠµë‹ˆë‹¤.

ì´ì œ ìŠ¤í‚¤ë§ˆë¥¼ push í•´ì„œ Sqlite í…Œì´ë¸”ì„ ë§Œë“¤ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

```bash
npx prisma db push
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": SQLite database "dev.db" at "file:./dev.db"

SQLite database dev.db created at file:./dev.db

ğŸš€  Your database is now in sync with your Prisma schema. Done in 15ms

Running generate... (Use --skip-generate to skip the generators)

added 1 package, and audited 503 packages in 5s

183 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

âœ” Generated Prisma Client (v5.8.0) to ./node_modules/@prisma/client in 47ms
```

Prisma Clientê¹Œì§€ ë§Œë“¤ì–´ì¡Œë„¤ìš”.

PrismaëŠ” Studioë¼ëŠ” ì•„ì£¼ í¸í•œ UIë¥¼ ì œê³µí•´ ì£¼ê³  ìˆì–´, Prisma DBì˜ ì‘ì„±ì— ì•„ì£¼ í° ë„ì›€ì´ ë˜ëŠ”ë°ìš”.

```bash
npx prisma studio
```

---

##  6. <a name='Lucia-1'></a>Lucia ì„¤ì¹˜ ë° ì½”ë“œ ì‘ì„±

Luciaì™€ Prisma ì–´ëŒ‘í„°ë¥¼ ê°™ì´ ì„¤ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.

```bash
npm i lucia @lucia-auth/adapter-prisma
```

ë‹¹ì—°íˆ ì„¸ì…˜ ê´€ë ¨ì´ë‹ˆê¹Œ Astroë¥¼ ì„œë²„ì‚¬ì´ë“œ ë Œë”ë§ìœ¼ë¡œ ë°”ê¿”ì•¼ í•©ë‹ˆë‹¤.

```bash
// astro.config.mjs

import { defineConfig } from 'astro/config';

// https://astro.build/config
export default defineConfig({
  output: 'server',
});
```

ë§Œì•½ ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ë‚˜ ê²½ê³ ê°€ ë‚˜ì˜¨ë‹¤ë©´ ê·¸ê±´ ë°”ë¡œ SSR ëª¨ë“œë¡œ ì„¤ì •í•˜ì§€ ì•Šì•„ì„œ ì¼ê²ë‹ˆë‹¤.

```bash
11:30:34 [WARN] `Astro.request.headers` is not available in "static" output mode. To enable header access: set `output: "server"` or `output: "hybrid"` in your config file.
```

--- 

###  6.1. <a name='lucia.ts'></a>lucia.ts íŒŒì¼ ë§Œë“¤ê¸°

ì´ì œ Asto ì½”ë“œì—ì„œ Luciaì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” lucia.ts íŒŒì¼ì„ ë§Œë“¤ ê±´ë°ìš”.

src í´ë” ë°‘ì— lib í´ë”ë¥¼ ë§Œë“¤ê³  ê·¸ ë°‘ì— ë§Œë“¤ê² ìŠµë‹ˆë‹¤.

```js
// src/lib/lucia.ts

import { lucia } from 'lucia';
import { astro } from 'lucia/middleware';
import { prisma } from '@lucia-auth/adapter-prisma';
import { PrismaClient } from '@prisma/client';

const client = new PrismaClient();

export const auth = lucia({
    adapter: prisma(client),
    env: import.meta.env.DEV ? 'DEV' : 'PROD',
    middleware: astro(),
});

export type Auth = typeof auth;
```

íƒ€ì…ì •ë³´ê¹Œì§€ exportí•˜ëŠ” ê±°ëŠ” Drizzle ORMê³¼ ë§ì´ ë¹„ìŠ·í•©ë‹ˆë‹¤.

ì´ì œ luciaë¥¼ ì´ìš©í•´ì„œ auth ê°ì²´ë¥¼ ë§Œë“¤ì—ˆìœ¼ë‹ˆê¹Œ ì•ìœ¼ë¡œ ì´ auth ê°ì²´ë¥¼ ì´ìš©í•´ì„œ ì„¸ì…˜ ê´€ë ¨ ì‘ì—…ì„ ì§„í–‰í•˜ë©´ ë©ë‹ˆë‹¤.

---

###  6.2. <a name='luciaenv.d.ts'></a>lucia ê´€ë ¨ íƒ€ì… env.d.ts ì„¤ì •

ìš°ë¦¬ê°€ schema.prisma íŒŒì¼ì—ì„œ ì •ì˜í•œ User, Session ëª¨ë¸ì˜ íƒ€ì…ì„ ì •í™•í•˜ê²Œ ê²€ìƒ‰í•  ìˆ˜ ìˆë„ë¡ env.d.ts íŒŒì¼ì— lucia ê´€ë ¨ ì •ë³´ë¥¼ ì •ì˜í•´ì•¼ í•©ë‹ˆë‹¤.

```js
// src/env.d.ts

/// <reference types="astro/client" />
/// <reference types="lucia" />
declare namespace Lucia {
    type Auth = import('./lib/lucia').Auth;
    type DatabaseUserAttributes = {};
    type DatabaseSessionAttributes = {};
}
```

---

###  6.3. <a name='middlewareauth'></a>middlewareë¥¼ ì´ìš©í•´ì„œ auth ê°ì²´ ì „ì—­í™” ì‹œí‚¤ê¸°

Astroì—ì„œ ê°ì²´ë¥¼ ì „ì—­í™” ì‹œí‚¤ëŠ” ê±´ context.localsë¥¼ ì´ìš©í•˜ë©´ ì•„ì£¼ ì‰¬ìš´ë°ìš”.

ê·¸ë˜ì„œ ë§¤ ë²ˆ Requestê°€ ë°œìƒí•  ë•Œë§ˆë‹¤ ë³€ê²½ëœ auth ê°ì²´ë¥¼ context.localsì— ì €ì¥í•´ì•¼ í•˜ëŠ”ë°ìš”.

ì´ë•Œ í•„ìš”í•œ ê²Œ ë¯¸ë“¤ì›¨ì–´ì…ë‹ˆë‹¤.

Astroì—ì„œëŠ” ë¯¸ë“¤ì›¨ì–´ëŠ” src í´ë” ë°‘ì— middleware.ts íŒŒì¼ì„ ë§Œë“¤ì–´ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
import { auth } from "./lib/lucia";
import { defineMiddleware } from "astro:middleware";

export const onRequest = defineMiddleware((context, next) => {
  context.locals.auth = auth.handleRequest(context);
  return next();
});
```

ì´ë ‡ê²Œ í•˜ë©´ context.locals.authì˜ íƒ€ì…ì´ ë¶€ì •í™•í•˜ë‹¤ê³  ë‚˜ì˜¤ëŠ”ë°ìš”.

ë‹¤ì‹œ 'env.d.ts' íŒŒì¼ì— ì•„ë˜ ë¶€ë¶„ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.

```js
// src/env.d.ts

/// <reference types="astro/client" />
/// <reference types="lucia" />
declare namespace Lucia {
  type Auth = import("./lib/lucia").Auth;
  type DatabaseUserAttributes = {};
  type DatabaseSessionAttributes = {};
}

///
declare namespace App {
  interface Locals {
    auth: import("lucia").AuthRequest;
  }
}
```

ì´ì œ middleware.tsì—ì„œ auth ë¶€ë¶„ì˜ íƒ€ì… ì—ëŸ¬ê°€ ì—†ì–´ì§ˆ ê²ë‹ˆë‹¤.

---

##  7. <a name='AstroJSLayout'></a>AstroJSì˜ Layout í˜ì´ì§€ ë§Œë“¤ê¸°

ë³¸ê²©ì ì¸ ì›¹í˜ì´ì§€ êµ¬ì„±ì— ë“¤ì–´ê°€ ë³´ê² ìŠµë‹ˆë‹¤.

AstroJSì—ì„œëŠ” ë¬´ì¡°ê±´ Layout í˜ì´ì§€ë¥¼ ë§Œë“œëŠ” ê²Œ ì•„ì£¼ í¸í•œë°ìš”.

ê·¸ë¦¬ê³ , ìš°ë¦¬ê°€ ë§Œë“¤ í˜ì´ì§€ì˜ ë§í¬ ë¶€ë¶„ì„ ë„£ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

```js
---
import { ViewTransitions } from "astro:transitions";
---

<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Astro</title>
    <ViewTransitions />
  </head>
  <body>
    <nav>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/login">Login</a></li>
        <li><a href="/signup">Signup</a></li>
        <li><a href="/dashboard">Dashboard</a></li>
      </ul>
    </nav>
    <slot />
  </body>
</html>
```

ì´ì œ src/pages í´ë”ì˜ index.astro íŒŒì¼ì„ ì†ë´ì•¼ í•˜ëŠ”ë°ìš”.

```js
// // src/pages/index.astro

---
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <h1>Home</h1>
</Layout>
```

ì´ì™• ë§Œë“œëŠ” ê±° src/pages/dashboard í´ë”ë¥¼ ë§Œë“¤ê³  ê·¸ë¦¬ê³  index.astro íŒŒì¼ì„ ì•„ë˜ì™€ ê°™ì´ ë˜‘ê°™ì´ ë§Œë“¤ì–´ ì¤ì‹œë‹¤.

```js
// src/pages/dashboard/index.astro

---
import Layout from "../../layouts/Layout.astro";
---

<Layout>
  <h1>Dashboard</h1>
</Layout>
```

ì´ì œ ê°œë°œ ì„œë²„ë¥¼ ëŒë ¤ ì „ì²´ì ì¸ í‹€ì´ ì‘ë™í•˜ëŠ”ì§€ ë³´ë©´ ë©ë‹ˆë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEiHgMjK2m7HebdQhocxfH5zYraXVJDsce0SgQsMZdihpsH0TX-Dg3nJeEtLw3oB8qxCq0k6RxrrZN6cJpuCE_CQTkYoGNOUMxcAoV5Ed0IjtKkec0zeK7jB8mX2rTvYEsLcZr3wVBrYoS6yGesF9sz0lszlRC2wS9PB6gHRoi1r-tw-92ZQic0CdgunJi8)

![](https://blogger.googleusercontent.com/img/a/AVvXsEjhpqjTxEIc-xrMRjZi64vrndWsv1C0wkn2_9P3fLAYvYMnalIvOGHrLw8N-MXKbWXPaNKDCGIPb3mTUx3kkR1EPswPRVXm4QPyZmJVOL3_OVRyIt19ZDwnVAA2QmK6S0MY_eM8l7nNSAqgEOV5mGJMnuE_2ujyBIDxEaKWOM-T1rW7MBWD1TWbcdbJUec)

ìœ„ì™€ ê°™ì´ home, dashboard ë§í¬ëŠ” ì •ìƒì‘ë™í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì•„ì§ loginê³¼ signup ë§í¬ëŠ” ì‘ë™í•˜ì§€ ì•ŠëŠ”ë°ìš”.

ì´ì œ ë§Œë“¤ì–´ ë³´ê² ìŠµë‹ˆë‹¤.

---

##  8. <a name='Signup'></a>Signup í˜ì´ì§€ ë§Œë“¤ê¸°

ë¨¼ì €, Signup í˜ì´ì§€ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ 'src/pages' í´ë” ë°‘ì— 'signup.astro' íŒŒì¼ì„ ë§Œë“¤ê² ìŠµë‹ˆë‹¤.

ë¨¼ì €, íƒ€ì… ì •í•©ì„± ê²€ì‚¬ë¥¼ ìœ„í•´ 'zod' ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.

```bash
npm i zod
```

ë³¸ê²©ì ì¸ signup.astro íŒŒì¼ì˜ ì½”ë“œì…ë‹ˆë‹¤.

```js
---
import { LuciaError } from "lucia";
import Layout from "../layouts/Layout.astro";
import { auth } from "../lib/lucia";
import z from "zod";

let usernameInput = "";
let errorMessages: z.ZodIssue[] = [];
let errorMessage: string | null = null;

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const username = formData.get("username");
  const password = formData.get("password");
  if (typeof username === "string") usernameInput = username;

  const result = z
    .object({
      username: z.string().min(4).max(31),
      password: z.string().min(8),
    })
    .safeParse({ username, password });

  if (!result.success) {
    errorMessages = result.error.errors;
    Astro.response.status = 400;
  } else {
    try {
      const user = await auth.createUser({
        key: {
          providerId: "username",
          providerUserId: result.data.username.toLowerCase(),
          password: result.data.password,
        },
        attributes: {},
      });
      const session = await auth.createSession({
        userId: user.userId,
        attributes: {},
      });
      Astro.locals.auth.setSession(session);
      return Astro.redirect("/dashboard", 302);
    } catch (e) {
      if (e instanceof LuciaError && e.message === "AUTH_DUPLICATE_KEY_ID") {
        errorMessage = "Username already taken";
        Astro.response.status = 400;
      } else {
        errorMessage = "Internal Server Error";
        Astro.response.status = 500;
      }
    }
  }
}
---

<Layout>
  <h1>Sign up</h1>
  <form method="post">
    <label for="username">Username</label>
    <input name="username" id="username" value={usernameInput} />
    <br />
    <label for="password">Password</label>
    <input type="password" name="password" id="password" />
    <br />
    {
      errorMessages.length > 0 &&
        errorMessages.map((error) => (
          <p>
            {error.path[0]}: {error.message}
          </p>
        ))
    }
    <p>{errorMessage}</p>
    <button type="submit">ê°€ì…í•˜ê¸°</button>
  </form>
  <br />
  <a href="/login">Sign in</a>
</Layout>
```

ì´ì œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ usernameê³¼ passwordì— ë„£ê³  í…ŒìŠ¤íŠ¸í•´ ë´…ì‹œë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEhY9Oozpec1biF9mNjBHxb1zN-S6f7Tyuunyy-7MK7HslA2-wu5c2bCCjKy8NL9aFM4IDAt_QE1i4cjvKwTSM8pNvOoJpsndqhCXAq6YHIAZmYKW3reTaAek5342DSMmZXyG9pDejRLZEygJajpo8cNnkPB8XC9oQlhtg8SWVJSfVliJy7Qpn_WXDl0ge4)

ìœ„ ê·¸ë¦¼ê³¼ ê°™ì´ zod ë¶€ë¶„ì´ ì •í™•í•˜ê²Œ ì‘ë™í•˜ê³  ìˆë„¤ìš”.

Luciaê°€ createUserí•˜ëŠ” ë°©ì‹ì€ keyë¥¼ ì´ìš©í•œ ë°©ì‹ì¸ë°ìš”.

Luciaê°€ ë§í•˜ëŠ” keyëŠ” ìœ ì €ì™€ ìœ ì €ë¥¼ ê°€ë¦¬í‚¤ëŠ” ë ˆí¼ëŸ°ìŠ¤ ì‚¬ì´ì˜ ê´€ê³„ë¥¼ ì–˜ê¸°í•©ë‹ˆë‹¤.

ì¡°ê¸ˆì€ ì–´ë ¤ìš¸ ìˆ˜ ìˆëŠ”ë°ìš”.

ìš°ë¦¬ê°€ ì‚¬ìš©í•œ Key ë°©ì‹ì€ ì „í†µì ì¸ ìœ ì €ë„¤ì„ê³¼ íŒ¨ìŠ¤ì›Œë“œ ë°©ì‹ì…ë‹ˆë‹¤.

ê·¸ë˜ì„œ ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•œ ê±°ì£ .

```js
const user = await auth.createUser({
        key: {
          providerId: "username",
          providerUserId: result.data.username.toLowerCase(),
          password: result.data.password,
        },
        attributes: {},
      });
```

ì „í†µì ì¸ username/password ë°©ì‹ì„ Luciaì—ì„œëŠ” Keyì˜ 'providerId'ë¼ê³  í•©ë‹ˆë‹¤.

ë§Œì•½ email/password ë°©ì‹ì´ë¼ë©´ Keyì˜ 'providerId'ëŠ” 'email'ì´ ë˜ëŠ” ê±°ì£ .

OAuthì˜ ê²½ìš° ë§Œì•½ Githubì„ ì´ìš©í•œë‹¤ë©´ Github user idê°€ í•´ë‹¹ë˜ëŠ” ê±°ì£ .

NextAuthì™€ëŠ” ì¡°ê¸ˆ ë‹¤ë¥¸ ê°œë…ì´ë¼ ì²˜ìŒì—ëŠ” ì–´ë µì§€ë§Œ ê³µì‹ ë¬¸ì„œë¥¼ ìì„¸íˆ ì‚´í´ë³´ë©´ ë§ì€ ì˜ˆê°€ ìˆìœ¼ë‹ˆê¹Œ ì°¸ê³  ë°”ëë‹ˆë‹¤.

key ë¶€ë¶„ì˜ providerUserIdì™€ password ë¶€ë¶„ì€ ì‹¤ì œ ìœ ì €ê°€ ì…ë ¥í•œ usernameê³¼ passwordë¥¼ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤.

zodì˜ safeParse í•¨ìˆ˜ë¥¼ ì´ìš©í–ˆê¸° ë•Œë¬¸ì— ê´€ë ¨ ê°’ì€ result ê°ì²´ì— ëª¨ë‘ ë‹¤ ìˆìœ¼ë‹ˆê¹Œ ê±°ê¸°ì„œ usernameê³¼ passwordë¥¼ ê°€ì ¸ì˜¤ë©´ ë©ë‹ˆë‹¤.

ì§€ê¸ˆí•˜ê³  ìˆëŠ” ê²Œ 'signup' ê°€ì…í•˜ê¸°ì…ë‹ˆë‹¤.

ê·¸ë˜ì„œ createUser í•¨ìˆ˜ë¥¼ ì‚¬ìš©í–ˆê³ , ê·¸ë‹¤ìŒ ê°€ì…í•œ ìœ ì €ì •ë³´ë¡œ ì„¸ì…˜ì„ ë§Œë“¤ì–´ ë¡œê·¸ì¸í•œ ìƒíƒœë¡œ ë°”ê¿”ì•¼ í•˜ëŠ”ë°ìš”.

ê·¸ë˜ì„œ ì‚¬ìš©í•œ í•¨ìˆ˜ê°€ auth.createSession í•¨ìˆ˜ì…ë‹ˆë‹¤.

```js
const session = await auth.createSession({
        userId: user.userId,
        attributes: {},
      });
```

ì„¸ì…˜ ì •ë³´ì—ëŠ” ë‹¹ì—°íˆ userIdë§Œ ë“¤ì–´ê°€ë©´ ë©ë‹ˆë‹¤.

Sessionì„ ì‘ì„±í•œ í›„, middlewareë¡œë¶€í„° ë°›ì€ Astro.locals.auth.setSession(AuthRequest.setSession)ì„ ì´ìš©í•˜ì—¬ ì¿ í‚¤ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

ì¿ í‚¤ì—ëŠ” Sessionì—ì„œ ë§Œë“  SessionIdê°€ í¬í•¨ë©ë‹ˆë‹¤.

ì¿ í‚¤ë¥¼ ë§Œë“  í›„ /dashboardë¡œ ë¦¬ë””ë ‰ì…˜ í•©ë‹ˆë‹¤.

ê·¸ ì™¸ ì—ëŸ¬í•¸ë“¤ë§ì€ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆì„ ê±°ë¼ íŒë‹¨ë˜ì–´ ë„˜ì–´ê°€ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

í…ŒìŠ¤íŠ¸í•´ ë³¼ê¹Œìš”?

í„°ë¯¸ë„ì„ í•˜ë‚˜ ë” ì—´ê³  'npx prisma studio'ë¥¼ ì‹¤í–‰í•´ì„œ prisma db ë‚´ìš©ì„ ì ê²€í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEiV9thHVXjUkod4mR2Cpyj-GJEqsPontlzg9M9aTC5tCqX0I5wlmHmUM9_1bLxuvixJFsDPK38DVZ_yjJHxInsuDK2lqlDN2iujfdfMbaXW4AKTkgVAjXKrYLa5TuW6Y6u-Lmv1ryAIQag2t28EaF1q2BH402Mjy3RK4n6Pu4m2vnSwvgsUWVpyVD031Uo)

![](https://blogger.googleusercontent.com/img/a/AVvXsEiF5uWIw_HauzRCVYxMSlVFpolOXg_Rv6eJpgl16yFe99CE4FuHfkw8FqEB2SS2CcFlzjmWlAScA3cq7l8pijK4kobM0NhgCJ1oyhH43mAZscr8enJ8-UwcuqB0tqJ2We7A1AUkFnWGfprAXMplrbS0gPB5OJhytoorU6_V1auVeqsmi3QBYud1XeoPLA8)

ìœ„ ë‘ ê·¸ë¦¼ì²˜ëŸ¼ Keyì™€ User ë¶€ë¶„ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ë„¤ìš”.

Session ë¶€ë¶„ì„ ë³¼ê¹Œìš”?

![](https://blogger.googleusercontent.com/img/a/AVvXsEgqo6xO9VqcGI9WAJ675vh6s-LhkNqgBdue339yEu-FezVaWvtqDtdMGMivdDJ88fis2RWrrVbtg9hnmlDir281MAFFOmQ93B2M-ddyIhGevh74iphHy9BU7r6KewOXOYL33IwrLRN8XAebjZ5LA_YmAF8T6_Oj_bklchhE5r9JaIMW9EyWNmY5jtFxGx0)

ìœ„ì—ì„œ ë³´ì‹œë©´ Sessionì˜ idê°€ 't3cf5....'ë¡œ ì‹œì‘í•˜ëŠ” ë¬¸ìì—´ì¸ë°ìš”.

í¬ë¡¬ ê°œë°œ ì°½ì˜ Applicationì— ë“¤ì–´ê°€ì„œ ì¿ í‚¤ë¥¼ ê²€ìƒ‰í•´ ë³¼ê¹Œìš”?

ê°œë°œ ì„œë²„ë‹ˆê¹Œ 'http://localhost:4321' ìª½ì— ì•„ë˜ì™€ ê°™ì´ 'auth_session' ì´ë¦„ìœ¼ë¡œ ì¿ í‚¤ê°€ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEg0-RRXfcyIb9tCS6n8MoPxaFkbHLHX0U1IPmIS3R2m_nEfWh9myeSMhqZS7Z31sCHzBlzfDgPXeigNgUhVoTPx56lzzjLT7AwcuWW2pLuuPSkzHN1UOJMgXUkbyRptLJ92qi_XIXvG5Sx2uIuJpQEoaB7yHBXvlitRuYV7Ad1EmULQy7YnqxWmwixNeWM)

ì¿ í‚¤ì˜ Valueë¥¼ ë³´ì‹œë©´ Prisma Studioì—ì„œ ë³¸ Session Id ê°’ì´ ê·¸ëŒ€ë¡œ ë“¤ì–´ê°€ ìˆë„¤ìš”.

ì§€ê¸ˆê¹Œì§€ ì„¤ëª…í–ˆë˜ Luciaì˜ ì„¸ì…˜ ê´€ë¦¬ ë°©ì‹ì´ ì œëŒ€ë¡œ ë“¤ì–´ë§ê³  ìˆìŠµë‹ˆë‹¤.

ê°€ì…í•˜ê¸°ëŠ” ì„±ê³µì ìœ¼ë¡œ ì‘ì„±í–ˆë„¤ìš”.

ë‹¨, ì—¬ê¸°ì„œ ì¶”ê°€í•  ê²Œ ìˆë‹¤ë©´ ê·¸ê±´ í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ì²´í¬í•´ì„œ ë¡œê·¸ì¸ë˜ì–´ ìˆë‹¤ë©´ dashboardë¡œ ì´ë™í•˜ëŠ” ê²ë‹ˆë‹¤.

ë¡œê·¸ì¸ëœ ì‚¬ëŒì´ ë‹¤ì‹œ ê°€ì…í•  ë¦¬ê°€ ì—†ê¸° ë•Œë¬¸ì´ì£ .

ë¡œê·¸ì¸ ìƒíƒœ ê²€ì‚¬ëŠ” ì•„ë˜ì™€ ê°™ì´ í•˜ë©´ ë©ë‹ˆë‹¤.

```js
// ì½”ë“œì˜ ë§ˆì§€ë§‰ì—

const session = await Astro.locals.auth.validate();
if (session) return Astro.redirect("/dashboard", 302);
```

ìœ„ì™€ ê°™ì´ í•˜ë©´ ì´ì œ ë¡œê·¸ì¸í•œ ìƒíƒœì—ì„œ '/signup' í˜ì´ì§€ë¡œ ê°€ë©´ ìë™ìœ¼ë¡œ '/dashboard' í˜ì´ì§€ë¡œ ì´ë™í•˜ê²Œ ë©ë‹ˆë‹¤.

---

##  9. <a name='login'></a>login í˜ì´ì§€ ë§Œë“¤ê¸°

ë¡œê·¸ì¸ì€ signupê³¼ ê±°ì˜ ë˜‘ê°™ì€ë°ìš”.

```js
---
import { LuciaError } from 'lucia';
import Layout from '../layouts/Layout.astro';
import { auth } from '../lib/lucia';
import z from 'zod';

let usernameInput = '';
let errorMessages: z.ZodIssue[] = [];
let errorMessage: string | null = null;

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const username = formData.get('username');
  const password = formData.get('password');
  if (typeof username === 'string') usernameInput = username;

  const result = z
    .object({
      username: z.string().min(4).max(31),
      password: z.string().min(8),
    })
    .safeParse({ username, password });

  if (!result.success) {
    errorMessages = result.error.errors;
    Astro.response.status = 400;
  } else {
    try {
      const key = await auth.useKey(
        'username',
        result.data.username.toLowerCase(),
        result.data.password
      );
      const session = await auth.createSession({
        userId: key.userId,
        attributes: {},
      });
      Astro.locals.auth.setSession(session);
      return Astro.redirect('/dashboard', 302);
    } catch (e) {
      if (
        e instanceof LuciaError &&
        (e.message === 'AUTH_INVALID_KEY_ID' ||
          e.message === 'AUTH_INVALID_PASSWORD')
      ) {
        errorMessage = 'Incorrect username or password';
        Astro.response.status = 400;
      } else {
        errorMessage = 'Internal Server Error';
        Astro.response.status = 500;
      }
    }
  }
}
const session = await Astro.locals.auth.validate();
if (session) return Astro.redirect('/dashboard', 302);
---
<Layout>
  <h1>Login</h1>
  <form method="post">
    <label for="username">Username</label>
    <input name="username" id="username" value={usernameInput} />
    <br />
    <label for="password">Password</label>
    <input type="password" name="password" id="password" />
    <br />
    {errorMessages.length > 0 &&
      errorMessages.map((error) => (
        <p>
          {error.path[0]}:{error.message}
        </p>
      ))}
    <p>{errorMessage}</p>
    <button type="submit">ë¡œê·¸ì¸í•˜ê¸°</button>
  </form>
  <br />
  <a href="/signup">Sign UP</a>
</Layout>
```

ìœ„ ì½”ë“œì—ì„œ ëˆˆ ì—¬ê²¨ë´ì•¼í•  ë¶€ë¶„ì€ useKey ë¶€ë¶„ì…ë‹ˆë‹¤.

```js
const key = await auth.useKey(
        'username',
        result.data.username.toLowerCase(),
        result.data.password
      );
```

login ë°©ì‹ì€ ë¨¼ì €, auth.useKey í•¨ìˆ˜ë¥¼ ì´ìš©í•´ì„œ ìœ ì €ê°€ formì—ì„œ ì…ë ¥í•œ usernameê³¼ passwordì„ 'providerId'ë¥¼ 'username' ë°©ì‹ìœ¼ë¡œ ê²€ì¦í•˜ê²Œ ë©ë‹ˆë‹¤.

ë°ì´í„°ë² ì´ìŠ¤ë‚´ì˜ ì •ë³´ì™€ ì¼ì¹˜í•˜ë©´ ì¼ì¹˜í•˜ëŠ” key ì •ë³´ë¥¼ ë¦¬í„´í•˜ê²Œ ë©ë‹ˆë‹¤.

key ë°ì´í„°ëŠ” userIdê°€ í¬í•¨ë˜ì–´ ìˆì–´ createSession í•¨ìˆ˜ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³  ë§ˆì°¬ê°€ì§€ë¡œ Astro.locals.auth.setSession() í•¨ìˆ˜ë¥¼ ì´ìš©í•´ì„œ ì¿ í‚¤ë¥¼ ì‘ì„±í•˜ê²Œ ë˜ëŠ”ê²ë‹ˆë‹¤.

---

##  10. <a name='Dashboard'></a>Dashboard í˜ì´ì§€ ì„¤ì •

ë¡œê·¸ì¸í•œ ìƒíƒœë¥¼ Dashboardì— ë°˜ì˜í•´ ë³¼ê¹Œìš”?

sessionì´ ì—†ìœ¼ë©´ login í˜ì´ì§€ë¡œ ì´ë™í•˜ê³  sessionì´ ìˆë‹¤ë©´ sessionì—ì„œ userì™€ userIdë¥¼ ê°€ì ¸ì™€ì„œ í™”ë©´ì— ì¶œë ¥í•˜ëŠ” ê²ë‹ˆë‹¤.

```js
---
import Layout from "../../layouts/Layout.astro";

const session = await Astro.locals.auth.validate();
if (!session) return Astro.redirect("/login", 302);
---

<Layout>
  <h1>Dashboard</h1>
  <div>{session.user.userId}</div>
</Layout>
```

ì•„ë˜ ê·¸ë¦¼ì²˜ëŸ¼ userIdê°€ ì œëŒ€ë¡œ ë‚˜íƒ€ë‚˜ê³  ìˆë„¤ìš”.

![](https://blogger.googleusercontent.com/img/a/AVvXsEieqd29GDZvOcbedNytyeX2dzw7vH8NMdoTkKnRpq8KkwOIDlZ6xTWiNOqMBTWOy_hoqeVMpBHLCv4kSVvTN0pBjUOJFMEWkynJ8ltldi3e31IHAhr6yO5itCnp2iJ67Qs_zbF5dGn9ZJAHFPzWEBdq9X2rYu0RgVNmBSwfe2hfT--BmoDXAwEhIqmedc0)

---

##  11. <a name='logout'></a>logout êµ¬í˜„

ë¡œê·¸ì¸í•˜ë©´ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ë¡œ ì´ë™í•œë‹¤ê³  í–ˆìœ¼ë‹ˆê¹Œ, ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ ì•ˆì— ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ê² ìŠµë‹ˆë‹¤.

ê¸°íƒ€ ì„œë²„ì‚¬ì´ë“œ ë Œë”ë§ì—ì„œ ê·¸ë ‡ë“¯ ë¡œê·¸ì•„ì›ƒì€ HTTP POST ë¦¬í€˜ìŠ¤íŠ¸ë¥¼ ë³´ë‚´ëŠ” ê²ë‹ˆë‹¤.

ëŒ€ì‹œë³´ë“œ í´ë”ì˜ index.astro íŒŒì¼ì„ ì•„ë˜ì™€ ê°™ì´ ë°”ê¿”ì¤ë‹ˆë‹¤.

```js
---
import Layout from "../../layouts/Layout.astro";

const session = await Astro.locals.auth.validate();
if (!session) return Astro.redirect("/login", 302);
---

<Layout>
  <h1>Dashboard</h1>
  <div>{session.user.userId}</div>
  <form method="post" action="/logout">
    <button type="submit">ë¡œê·¸ì•„ì›ƒ</button>
  </form>
</Layout>
```

HTTP POST ë¦¬í€˜ìŠ¤íŠ¸ì˜ ëª©ì ì§€ê°€ ë°”ë¡œ "/logout" ê²½ë¡œì¸ë°ìš”.

pages í´ë” ë°‘ì— logout.ts íŒŒì¼ì„ ë§Œë“¤ê³  POST ë¦¬í€˜ìŠ¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¡œì§ì„ ë§Œë“¤ë©´ ë©ë‹ˆë‹¤.

ì´ íŒŒì¼ì˜ í™•ì¥ìê°€ ì™œ '.ts'ì¼ê¹Œìš”?

ë°”ë¡œ UI ë¶€ë¶„ì´ ì—†ê³  ë¡œì§ë§Œ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

```js
// src/pages/logout.ts

import { auth } from "../lib/lucia";

import type { APIRoute } from "astro";

export const POST: APIRoute = async (context) => {
  const session = await context.locals.auth.validate();
  if (!session) {
    return new Response("Unauthorized", {
      status: 401,
    });
  }

  await auth.invalidateSession(session.sessionId);
  context.locals.auth.setSession(null);
  return context.redirect("/login", 302);
};
```

ë¡œê·¸ì•„ì›ƒì˜ ë¡œì§ì€ ë¨¼ì €, Astroì˜ POST API ì—”ë„í¬ì¸íŠ¸ë¡œì˜ ì‘ì„±ì¸ë°ìš”.

POST ë¦¬í€˜ìŠ¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê¸° ë•Œë¬¸ì— ì´ë¦„ì´ POSTì…ë‹ˆë‹¤.

ë¨¼ì €, session ì •ë³´ë¥¼ ì–»ê³  ë‚˜ì„œ ë§Œì•½ sessionì´ ì—†ë‹¤ë©´ 'Unauthorized' ë©”ì‹œì§€ì™€ í•¨ê»˜ 401 Responseë¥¼ ë³´ë‚´ë©´ ë©ë‹ˆë‹¤.

sessionì´ ìˆë‹¤ë©´ invalidateSesion í•¨ìˆ˜ë¡œ ì„¸ì…˜ì„ ë¬´ë ¥í™”í•˜ê³ , ê·¸ë‹¤ìŒ context.locals.auth.setSession(null) ëª…ë ¹ì–´ë¡œ í´ë¼ì´ì–¸íŠ¸ì˜ ì¿ í‚¤ë¥¼ ë¬´ë ¥í™”ì‹œí‚µë‹ˆë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ '/login' í˜ì´ì§€ë¡œ ì´ë™í•˜ë©´ ëì¸ ê±°ì£ .

í…ŒìŠ¤íŠ¸í•´ë³´ì‹­ì‹œì˜¤.

ì˜ ë  ê²ë‹ˆë‹¤.

---

ì§€ê¸ˆê¹Œì§€ AstroJSì™€ Luciaë¥¼ ì´ìš©í•œ ìœ ì € ê°€ì…, ë¡œê·¸ì¸ì„ êµ¬í˜„í•´ ë´¤ìŠµë‹ˆë‹¤.

Luciaê°€ ì¡°ê¸ˆì€ ìƒì†Œí• ì§€ ëª¨ë¥´ì§€ë§Œ Astroë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ê¼­ ë°°ì›Œì•¼ í•  ì¸ì¦ ë¼ì´ë¸ŒëŸ¬ë¦¬ì„ì—ëŠ” í‹€ë¦¼ì—†ë„¤ìš”.

ê·¸ëŸ¼.
