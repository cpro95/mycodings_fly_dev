---
slug: 2023-08-07-sveltekit-with-prisma-and-deploy-to-fly-io
title: SvelteKit ì‹¤ì „ ì˜ˆì œ 4í¸ - Prisma ì„¤ì¹˜ í›„ ë°± ì—”ë“œ DB ì„¸íŒ… ë° í´ë¼ìš°ë“œì— ìë™ ë°°í¬í•˜ê¸°
date: 2023-08-07T11:57:32.593Z
description: Dockerfile ì„¸íŒ…í•´ì„œ ìë™ìœ¼ë¡œ Prisma ì„¤ì¹˜ ë° ì´ˆê¸° ë°ì´í„° ì„¸íŒ…ê¹Œì§€
meta:
  keywords:
    - prisma
    - sveltekit
    - sveltejs
    - fly.io
published: true
---

# SvelteKit ì‹¤ì „ ì˜ˆì œ 4í¸ - Prisma ì„¤ì¹˜ í›„ ë°± ì—”ë“œ DB ì„¸íŒ… ë° í´ë¼ìš°ë“œì— ìë™ ë°°í¬í•˜ê¸°

ì•ˆë…•í•˜ì„¸ìš”?

ì´ë²ˆ ì‹œê°„ì—ëŠ” ì¢€ ë” ì–´ë ¤ìš´ ì£¼ì œì¸ë°ìš”.

ë°”ë¡œ Sveltekitì—ì„œ ë°± ì—”ë“œì—ì„œ ì‘ë™í•˜ëŠ” DB ì„¸íŒ… ë°©ë²•ê³¼ Fly.ioì— ë°°í¬ê¹Œì§€ í•  ìˆ˜ ìˆëŠ” Dockerfileì„ ì‘ì„±í•  ì˜ˆì •ì…ë‹ˆë‹¤.

**-ì§€ë‚œ ì‹œê°„ ê°•ì¢Œ ë³´ê¸°-**

[SvelteKit ì‹¤ì „ ì˜ˆì œ - Fly.ioì— ë°°í¬(deploy)í•˜ê¸° with ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§](https://mycodings.fly.dev/blog/2023-08-03-how-to-deploy-sveltekit-to-fly-io-with-server-side-rendering)

[SvelteKit ì‹¤ì „ ì˜ˆì œ 2í¸ - ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§ í’€ ìŠ¤íƒ ë¬´ë¹„ ì•± ë§Œë“¤ê¸°](https://mycodings.fly.dev/blog/2023-08-05-sveltekit-server-side-full-stack-example-and-fly-io-deploy)

[SvelteKit ì‹¤ì „ ì˜ˆì œ 3í¸ - Github Actionìœ¼ë¡œ ìë™ ë°°í¬í•˜ê¸°(Auto Deploy)](https://mycodings.fly.dev/blog/2023-08-07-sveltekit-auto-deploy-with-github-action-to-fly-io)

ê·¸ëŸ¬ë©´ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.

---

## Prisma

Next.jsë‚˜ Remix Frameworkìœ¼ë¡œ í’€ ìŠ¤íƒ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë§Œë“¤ ë•Œ ê°€ì¥ ë§ì´ ì“°ì´ëŠ” ë°± ì—”ë“œ DB ê´€ë ¨ ORMì€ ë°”ë¡œ Prismaì¸ë°ìš”.

MySql, PostgreSQL, MongoDB, Sqlite3 ë“± ë‹¤ì–‘í•œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.

í•œ ê°œì˜ ì½”ë“œë¡œ DB ìœ í˜•ì„ ë°”ê¿” ê°€ë©´ì„œ ì„¸íŒ…í•  ìˆ˜ ìˆì–´ ì•„ì£¼ í¸í•œë°ìš”.

ì˜¤ëŠ˜ì€ ê°œë°œ ì„œë²„ ë° ë¸”ë¡œê·¸ ê°•ì¢Œë¼ì„œ sqlite3 ë¡œ ê°œë°œ í•˜ê² ìŠµë‹ˆë‹¤.

## Prisma ì„¤ì¹˜

ë¨¼ì €, ì•„ë˜ì™€ ê°™ì´ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
npx prisma init --datasource-provider sqlite
```

ì´ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ prisma ì„¸íŒ… íŒŒì¼ì´ ìƒê¸°ëŠ”ë°ìš”.

.env íŒŒì¼ê³¼ ê·¸ë¦¬ê³  prisma í´ë”ê°€ ìƒê¹ë‹ˆë‹¤.

prisma í´ë”ì—ëŠ” schema.prisma íŒŒì¼ì´ ìƒê¸°ëŠ”ë°ìš”.

ë°ì´í„°ë² ì´ìŠ¤ì˜ ë¼ˆëŒ€ë¥¼ êµ¬ì„±í•˜ëŠ” ê¸°ì´ˆ íŒŒì¼ì…ë‹ˆë‹¤.

ìš°ë¦¬ëŠ” DB í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ User ëª¨ë¸ë¡œ ë¡œê·¸ì¸ì„ êµ¬í˜„í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ schema.prisma íŒŒì¼ì— model User ë¶€ë¶„ì„ ì¶”ê°€í•´ ì£¼ì‹­ì‹œì˜¤.

```bash
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String @id @default(uuid())
  username      String @unique
  passwordHash  String
  userAuthToken String @unique
  role          String @default("USER")

  createAt  DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

ì´ì œ Prismaë¥¼ ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” PrismaClientë¥¼ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.

```bash
npm i @prisma/client
```

ì¼ë‹¨ ì—¬ê¸°ê¹Œì§€ ì§„í–‰í–ˆìœ¼ë©´ PrismaClientë¥¼ ìƒì„±í•´ì•¼ í•˜ëŠ”ë°ìš”.

ë‘ ê°€ì§€ë¡œ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

node_modules ë¶€ë¶„ê³¼ ì½”ë“œ ë¶€ë¶„ì…ë‹ˆë‹¤.

ë¨¼ì €, node_modules ë¶€ë¶„ì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì´ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰ì‹œí‚¤ë©´ ë©ë‹ˆë‹¤.

```bash
npx prisma db push
```
ë¼ê³  ì‹¤í–‰í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.

```bash
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": SQLite database "dev.db" at "file:./dev.db"

SQLite database dev.db created at file:./dev.db

ğŸš€  Your database is now in sync with your Prisma schema. Done in 27ms

âœ” Generated Prisma Client (5.1.1 | library) to ./node_modules/@prisma/client in 96ms
```

ì¦‰, .env íŒŒì¼ì— ìˆëŠ” DATABASE_URL ë³€ìˆ˜ë¥¼ ì½ì–´ì„œ ë””ìŠ¤í¬ ìƒì— ì‹¤ì œ db íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤.

ê·¸ë¦¬ê³  Prisma Clientë¥¼ ì½”ë“œ ë¶€ë¶„ì—ì„œ ë§Œë“¤ì–´ ì£¼ëŠ”ë°ìš”.

Prisma Client í´ë¼ì´ì–¸íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ëª…ë ¹ì–´ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```bash
npx prisma generate
```

ë‹¤ì‹œ í•œë²ˆ ì‹¤í–‰í•´ë„ ê´œì°®ìŠµë‹ˆë‹¤.

ì´ì œ ì½”ë“œ ë¶€ë¶„ì—ì„œ PrismaClientë¥¼ ì„¸íŒ…í•´ì•¼ í•˜ëŠ”ë°ìš”.

src/lib í´ë”ì— database.ts íŒŒì¼ì„ ë§Œë“­ì‹œë‹¤.

```js
import prisma from "@prisma/client";

export const db = new prisma.PrismaClient();
```

ì´ì œ ìš°ë¦¬ëŠ” Prismaë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì œë°˜ì‚¬í•­ì„ ëª¨ë‘ ë§Œë“¤ì—ˆëŠ”ë°ìš”.

## DBì— ìë™ìœ¼ë¡œ ì´ˆê¸°ê°’ ë„£ëŠ” seed íŒŒì¼ ë§Œë“¤ê¸°

PrismaëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì²˜ìŒ ë¹Œë“œì‹œ DB ê°’ì„ ì´ˆê¸°í™”í•  ìˆ˜ ìˆëŠ” seed íŒŒì¼ì„ ì œê³µí•˜ëŠ”ë°ìš”.

ë¨¼ì €, package.json íŒŒì¼ì—ì„œ ë§¨ ëì— ì•„ë˜ì²˜ëŸ¼ ì½”ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

```js
  "prisma": {
      "seed": "node prisma/seed.js"
    }
```
package.json ì—ì„œ prisma í•­ëª©ì´ë€ ê±¸ ë§Œë“¤ì—ˆê³ , ì‹¤ì œ ì´ ë¶€ë¶„ì€ Prismaê°€ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.

ì½”ë“œë¥¼ ë³´ì‹œë©´ seed ë¶€ë¶„ì´ node ëª…ë ¹ì–´ ì‹¤í–‰ ì´ë€ê±¸ ë³¼ ìˆ˜ ìˆëŠ”ë°ìš”.

ì´ì œ ì´ seed.js íŒŒì¼ì„ ë§Œë“¤ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

prisma í´ë”ì— ë§Œë“¤ë©´ ë©ë‹ˆë‹¤.

```js
import { PrismaClient } from "@prisma/client";
import bcrypt from "bcrypt";
import crypto from 'crypto';

const prisma = new PrismaClient();

async function seed() {
    const username = "test";

    // cleanup the existing database
    await prisma.user.delete({ where: { username: username } }).catch(() => {
        // console.log("Delete database")
    });

    const hashedPassword = await bcrypt.hash("1234", 10);

    const user = await prisma.user.create({
        data: {
            username: username,
            passwordHash: hashedPassword,
            userAuthToken: crypto.randomUUID(),
            role: "ADMIN"
        },
    });

    if (user) console.log(`Database has been seeded.!\n${user}`);
}

seed()
    .catch((e) => {
        console.error(e);
        process.exit(1);
    })
    .finally(async () => {
        await prisma.$disconnect();
    });
```

ì½”ë“œë¥¼ ë³´ì‹œë©´ User í…Œì´ë¸”ì— ì‹ ê·œ ì‚¬ìš©ìë¥¼ ì§ì ‘ ì§‘ì–´ë„£ëŠ” ì½”ë“œì¸ë°ìš”.

ì²œì²œíˆ ë³´ì‹œë©´ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆì„ ê²ë‹ˆë‹¤.

ê·¸ë¦¬ê³  ì´ê±¸ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” bcrypt íŒ¨í‚¤ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.

bcryptëŠ” ì•”í˜¸ë¥¼ í•´ì‹œ í•˜ëŠ” íˆ´ì…ë‹ˆë‹¤.

```js
npm i bcrypt
npm i -D @types/bcrypt prisma
```

ê·¸ë¦¬ê³  ì—¬ê¸°ì„œ prismaë„ ì§ì ‘ ì„¤ì¹˜í•˜ê²Œë” ëª…ë ¹ì–´ë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

ì´ì œ ì¤€ë¹„ê°€ ëë‚œ ê±° ê°™ì€ë°ìš”.

## ì‹¤ì œ DB ì ìš©í•˜ê¸°

ì´ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ë€ ê±¸ í•´ì•¼ í•˜ëŠ”ë°ìš”.

Schema íŒŒì¼ì„ SQL íŒŒì¼ë¡œ ë³€í™˜í•´ ì£¼ëŠ” ê²ë‹ˆë‹¤.

```bash
npx prisma migrate dev
```

```bash
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": SQLite database "dev.db" at "file:./dev.db"

Drift detected: Your database schema is not in sync with your migration history.

The following is a summary of the differences between the expected database schema given your m
igrations files, and the actual schema of the database.                                        
It should be understood as the set of changes to get from the expected schema to the actual sch
ema.                                                                                           
If you are running this the first time on an existing database, please make sure to read this d
ocumentation page:                                                                             https://www.prisma.io/docs/guides/database/developing-with-prisma-migrate/troubleshooting-devel
opment                                                                                         
[+] Added tables
  - User

[*] Changed the `User` table
  [+] Added unique index on columns (userAuthToken)
  [+] Added unique index on columns (username)

âœ” We need to reset the SQLite database "dev.db" at "file:./dev.db"
Do you want to continue? All data will be lost. â€¦ yes

âœ” Enter a name for the new migration: â€¦ 
Applying migration `20230807122145_`

The following migration(s) have been created and applied from new schema changes:

migrations/
  â””â”€ 20230807122145_/
    â””â”€ migration.sql

Your database is now in sync with your schema.

âœ” Generated Prisma Client (5.1.1 | library) to ./node_modules/@prisma/client in 115ms


Running seed command `node prisma/seed.js` ...
Database has been seeded.!
[object Object]

ğŸŒ±  The seed command has been executed.
```

ë§ˆì´ê·¸ë ˆì´ì…˜ì„ í•˜ë‹ˆê¹Œ prisma seed ê¹Œì§€ ì™„ë²½íˆ ì‹¤í–‰ í–ˆë„¤ìš”.

ì‹¤ì œ sqlite DB íŒŒì¼ì— ë“¤ì–´ê°€ ë³¼ê¹Œìš”?

```bash
cd prisma
sqlite3 dev.db
```
ìœ„ì™€ ê°™ì´ ì‹¤í–‰í•˜ê³  ì•„ë˜ì™€ ê°™ì´ User ë¶€ë¶„ì˜ ë ˆì½”ë“œë¥¼ select í•´ë³´ë©´ test ìœ ì €ê°€ ì˜ ë³´ì…ë‹ˆë‹¤.

```bash
SQLite version 3.37.0 2021-12-09 01:34:53
Enter ".help" for usage hints.
sqlite> select * from user;
f3f9d8c8-d19d-43ef-9660-a58f68effe67|test|$2b$10$WF/xmu4abbapYjkZfuHM/.Dpr2t9KSMEF8jayiNGTNjSdy
tAmUtb2|3d06c60f-fb6d-4d78-9270-58d7c6d3b50e|ADMIN|1691410906968|1691410906968   sqlite> .quit
```

ê·¸ëŸ¬ë©´ ì´ì œ Prismaë¥¼ ì´ìš©í•´ì„œ SvelteKitì—ì„œ ì½”ë“œë¥¼ ì‘ì„±í•´ ë³¼ê¹Œìš”?

---

## get_user API ì—”ë“œí¬ì¸íŠ¸ ë§Œë“¤ê¸°

DBëŠ” ë°±ì—”ë“œì´ê¸° ë•Œë¬¸ì— ì„œë²„ì‚¬ì´ë“œì—ì„œ ì‘ë™í•©ë‹ˆë‹¤.

APIë¥¼ ë§Œë“¤ì–´ ë†“ìœ¼ë©´ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œë‚˜ ë°± ì—”ë“œ ì‚¬ì´ë“œì—ì„œë‚˜ ì–¸ì œë“ ì§€ ììœ ë¡­ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ì„œ ì•„ì£¼ ìœ ìš©í•œë°ìš”.

api/get_user ê²½ë¡œë¡œ API ì—”ë“œ í¬ì¸íŠ¸ë¥¼ í•˜ë‚˜ ë§Œë“¤ê² ìŠµë‹ˆë‹¤.

src/routes/api/get_user/+server.ts íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤.

```js
import { db } from "$lib/database";
import { json } from "@sveltejs/kit";

async function getUser() {
  try {
    const user = await db.user.findMany({
      where: { role: "ADMIN" },
    });
    return user;
  } catch (e) {
    throw new Error(`Could not find User`);
  }
}

export async function GET() {
  const user = await getUser();
  return json(user);
}
```

í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ role ì´ "ADMIN"ì¸ ê±¸ ì°¾ëŠ” ì½”ë“œì¸ë°ìš”.

HTTP GET ë©”ì„œë“œë¡œ ì‘ë™í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.

ì €ì¥í•˜ê³  ê°œë°œì„œë²„ë¥¼ ëŒë ¤ë³¼ê¹Œìš”?

![](https://blogger.googleusercontent.com/img/a/AVvXsEjLgj0NuFd4ZHgGwGGxoh3DVZbx_8m_PwQd4lsY7RlqZZ-zZ0aE3fR11Zu38Bgu8KRh6p-yes17hdpASRbMRYxsLZqpbBiEJRsElXj9xiQdXNWEID8F3Kq7jNOr-4GKPXPy8FZMVLNYq1gkdvTu_odqx1r4anJVqF_lolkhmDEaSwHuoDxGzVdPMwyfuA0)

get_user ë¶€ë¶„ì´ ì•„ì£¼ ì˜ ì‘ë™í•˜ë„¤ìš”.

## API ì—”ë“œ í¬ì¸íŠ¸ë¥¼ í™œìš©í•˜ì—¬ í˜ì´ì§€ì— ë¿Œë¦¬ê¸°

ì´ì œ ìš°ë¦¬ ì•±ì˜ ìµœìƒë‹¨ ê²½ë¡œì¸ '/'ì— user ë¶€ë¶„ì„ í™”ë©´ì— ë¿Œë ¤ì£¼ê² ìŠµë‹ˆë‹¤.

ì˜¨ì „íˆ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì‘ì—…ì…ë‹ˆë‹¤.

/src/routes/+page.server.ts íŒŒì¼ì„ ì—´ì–´ë³´ì‹œë©´ ì§€ë‚œ ì‹œê°„ì— ì‘ì„±í•œ popularMovies ì–»ëŠ” ì½”ë“œê°€ ìˆëŠ”ë°ìš”.

ê±°ê¸°ì— ì´ì–´ì„œ User ë¶€ë¶„ë„ ì–»ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.

```js
export async function load({ fetch }) {
  const response = await fetch("api/get_popular_movies");
  const popularMovies = await response.json();

  const response2 = await fetch("api/get_user");
  const user = await response2.json();

  return { popularMovies, user };
}
```

ì´ì œ, +page.svelte íŒŒì¼ì—ì„œ ì§ì ‘ í™”ë©´ì— ë¿Œë¦¬ëŠ” ì½”ë“œë¥¼ ì¶”ê°€í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```js
<script lang="ts">
  export let data;

  const popularMovies = data.popularMovies.results;
  const user = data.user[0];
  console.log(user);
</script>

<h1 class="text-4xl font-bold">Welcome to SvelteKit</h1>

{#if user.username}
  <h2 class="text-2xl font-semibold">Hello! {user.username}</h2>
{:else}
  <h2 class="text-2xl font-semibold">Hello! There!</h2>
{/if}

<ul class="p-4 mt-4">
  {#each popularMovies as movie}
    <li>
      <a href={`/${movie.id}`}>
        {movie.title} / {movie.vote_average}
      </a>
    </li>
  {/each}
</ul>
```

ì‹¤í–‰ê²°ê³¼ë¥¼ ë³¼ê¹Œìš”?

![](https://blogger.googleusercontent.com/img/a/AVvXsEgK4gAhljPs00KQjT_wLHbH1LkPyV0JWv8D4wG_wuKC9bkyTJdDKBwWL_KIuq7xJBWXO2iKBA2d36dV44ubGkGsTa1gmJ3tG_QMWGmUJRNZRDqiEFmGhPqKSCErLjLVPZUFGt5TvEHGcGbnouZQQnZaeEkaJ1cNhwpDCXtIjOsCzTKzfP26X7OxwtEIufg)

ìœ„ì™€ ê°™ì´ User ë¶€ë¶„ë„ ì˜ ë‚˜ì˜¤ë„¤ìš”.

---

## Fly.ioì— ë°°í¬í•˜ê¸°

í˜„ì¬ ë¡œì»¬ìƒ ê°œë°œ ì„œë²„ì—ì„œëŠ” ì •ìƒ ì‘ë™í•˜ëŠ”ë°ìš”.

ê·¸ëŸ¬ë©´ Fly.ioì— ë°°í¬í–ˆì„ ë•Œë„ ë˜‘ê°™ì´ ì‘ë™í•˜ëŠëƒê°€ ë¬¸ì œì¸ë°ìš”.

Fly.ioì— Prismaê°€ ì‘ë™ë˜ê²Œ í•˜ë ¤ë©´ ë§ì€ ì¡ë‹¤í•œ ì‘ì—…ì„ í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.

## Volumes ì°¾ê¸°

Fly.ioëŠ” ë„ì»¤ë¡œ ì›€ì§ì´ëŠ”ë°ìš”.

ê·¸ëŸ°ë° Fly.ioëŠ” ë”°ë¡œ DBìš© ë””ìŠ¤í¬ë„ ì§€ì›í•´ ì¤ë‹ˆë‹¤.

ìš°ë¦¬ëŠ” ì´ê±¸ 1GB í˜•ì‹ìœ¼ë¡œ ì§€ì •í•  ìˆ˜ ìˆëŠ”ë°ìš”.

ì¼ë‹¨ ì§€ê¸ˆ ìƒíƒœë¥¼ ì‚´í´ë³¼ê¹Œìš”?

```bash
sveltekit-deploy-on-fly-io git:(main) âœ— flyctl volumes list
```

ìœ„ì™€ ê°™ì´ ëª…ë ¹ì–´ë¥¼ ì¹˜ì‹œë©´ ì•„ë˜ì™€ ê°™ì´ ë‚˜ì˜¤ëŠ”ë°ìš”.

```bash
ID                      STATE   NAME    SIZE    REGION  ZONE    ENCRYPTED       ATTACHED VM   CREATED AT  
vol_0o6d4230231r87gy    created data    1GB     nrt     fe01    true            e784e669a416389 hours ago                                                                                   
```

ì € ê°™ì€ ê²½ìš°ëŠ” NAMEì´ dataì¸ ë””ìŠ¤í¬ë¡œ 1GBê°€ nrt REGION(ë„ì¿„)ì´ ìˆë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.

ë§Œì•½ ì—†ë‹¤ë©´ ì•„ë˜ ëª…ë ¹ì–´ë¡œ ì§ì ‘ ë§Œë“¤ë©´ ë©ë‹ˆë‹¤.

```bash
fly volumes create data --size 1 --app my-svelteki-test2
```

ë””ìŠ¤í¬ ì´ë¦„ì€ dataë¡œ ì •í–ˆìœ¼ë©° 1GBì´ê³  í•´ë‹¹ ì•±ì€ my-svelteki-test2 ì…ë‹ˆë‹¤.

ì ì´ì œ, DBë¥¼ ìœ„íŒ ë””ìŠ¤í¬ ìŠ¤í˜ì´ìŠ¤ë„ í™•ë³´í–ˆìœ¼ë‹ˆê¹Œ ë³¸ê²©ì ì¸ ë°°í¬ì‘ì—…ì— ë“¤ì–´ê°€ ë³´ê² ìŠµë‹ˆë‹¤.

## fly.toml íŒŒì¼ ìˆ˜ì •í•˜ê¸°

ì¼ë‹¨ Fly.ioì— Prisma DB ì‚¬ìš©ì„ ìœ„í•œ ë„ì»¤ë¥¼ ì˜¬ë¦¬ê¸° ìœ„í•´ì„œëŠ” ëª‡ ê°€ì§€ ê¸°ë²•ì´ ì ìš©ë˜ëŠ”ë°ìš”.

ì¼ë‹¨ ì•„ë˜ì™€ ê°™ì´ fly.toml íŒŒì¼ì—ì„œë„ ì‹¤í—˜ì ìœ¼ë¡œ ì œê³µí•´ ì£¼ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

```toml
# fly.toml app configuration file generated for my-svelteki-test2 on 2023-08-03T22:20:33+09:00
#
# See https://fly.io/docs/reference/configuration/ for information about how to use this file.
#

app = "my-svelteki-test2"
primary_region = "nrt"

[env]
  DATABASE_URL = "file:/data/sqlite.db"

[experimental]
  allowed_public_ports = []
  auto_rollback = true
  cmd = "start.sh"
  entrypoint = "sh"
  
[mounts]
  source = "data"
  destination = "/data"

[http_service]
  internal_port = 3000
  force_https = true
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 0
  processes = ["app"]
```

ìœ„ íŒŒì¼ì—ì„œ ì œì¼ ì¤‘ìš”í•œ ë¶€ë¶„ì´ ë°”ë¡œ mountsì¸ë°ìš”.

dataë¼ëŠ” ì´ë¦„ì˜ ìš°ë¦¬ ë””ìŠ¤í¬ ìŠ¤í˜ì´ìŠ¤ë¥¼ ê²½ë¡œëª… "/data"ë¡œ ë§ˆìš´íŠ¸ í•œë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.

ë‚˜ì¤‘ì— ì½˜ì†”ì—ì„œ ì§ì ‘ ë³´ì—¬ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³ , ìœ„ íŒŒì¼ì„ ë³´ì‹œë©´ env ë¶€ë¶„ì— DATABASE_URL ê°’ì´ ìˆìŠµë‹ˆë‹¤.

ì´ ë³€ìˆ˜ì˜ ê°’ì´ file:/data/ ë¡œ ì‹œì‘í•˜ëŠ”ë°ìš”.

/data ê²½ë¡œëŠ” ì•„ê¹Œ ìš°ë¦¬ê°€ ë§Œë“¤ì—ˆë˜ ë””ìŠ¤í¬ ìŠ¤í˜ì´ìŠ¤ë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤.

ì¦‰, /data í´ë” ë°‘ì— sqlite.db íŒŒì¼ì´ë¦„ìœ¼ë¡œ í•˜ë¼ëŠ” ì–˜ê¸°ì£ .

ê·¸ë¦¬ê³ , experimental ë¶€ë¶„ì— cmd ë¶€ë¶„ê³¼ entrypointê°€ ìˆëŠ”ë°ìš”.

ì´ ê±´ ì‹¤ì œ, bash íŒŒì¼ì„ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

start.sh íŒŒì¼ì„ ìš°ë¦¬ í”„ë¡œì íŠ¸ ìµœìƒë‹¨ì— ì‘ì„±í•©ì‹œë‹¤.

package.json íŒŒì¼ê³¼ ê°™ì€ ìœ„ì¹˜ì…ë‹ˆë‹¤.

```sh
#!/bin/sh

# This file is how Fly starts the server (configured in fly.toml). Before starting
# the server though, we need to run any prisma migrations that haven't yet been
# run, which is why this file exists in the first place.
# Learn more: https://community.fly.io/t/sqlite-not-getting-setup-properly/4386

set -ex

# Finally start the app
npx prisma migrate deploy
npx prisma db seed
npm run start
```

ìœ„ ì½”ë“œë¥¼ ë³´ì‹œë©´ prisma ë¶€ë¶„ì„ ì‹¤í–‰ì‹œì¼œ ì£¼ë©´ì„œ ë§ˆì§€ë§‰ìœ¼ë¡œ ì„œë²„ë¥¼ êµ¬ë™í•˜ëŠ” "npm run start"ë¥¼ ì‹¤í–‰ì‹œí‚¤ëŠ” ì½”ë“œì¸ë°ìš”.

ì´ ì½”ë“œê°€ ìµœì¢…ì ìœ¼ë¡œ ìš°ë¦¬ ì„œë²„ë¥¼ ì‹œì‘í•˜ëŠ” íŒŒì¼ ì¸ê±°ì£ .

## Dockerfile ê°œì¡°í•˜ê¸°

ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ê²©ì ìœ¼ë¡œ Dockerfileì„ ê°œì¡°í•´ì•¼ í•˜ëŠ”ë°ìš”.

ì „ì²´ ë‚´ìš©ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```bash
# base node image
FROM node:16-bullseye-slim as base

# set for base and all layer that inherit from it
ENV NODE_ENV production

ENV DATABASE_URL=file:/data/sqlite.db
ENV NODE_ENV="production"

# Set TMDB API key at build time
ARG TMDB_API_KEY
ENV VITE_TMDB_API_KEY=$TMDB_API_KEY

# Install openssl for Prisma
RUN apt-get update && apt-get install -y openssl sqlite3

# Install all node_modules, including dev dependencies
FROM base as deps

WORKDIR /myapp

ADD package.json .npmrc ./
RUN npm install --include=dev

# Setup production node_modules
FROM base as production-deps

WORKDIR /myapp

COPY --from=deps /myapp/node_modules /myapp/node_modules
ADD package.json .npmrc ./
RUN npm prune --omit=dev

# Build the app
FROM base as build

WORKDIR /myapp

COPY --from=deps /myapp/node_modules /myapp/node_modules

ADD prisma .
RUN npx prisma generate

ADD . .
RUN npm run build

# Finally, build the production image with minimal footprint
FROM base

WORKDIR /myapp

COPY --from=production-deps /myapp/node_modules /myapp/node_modules
COPY --from=build /myapp/node_modules/.prisma /myapp/node_modules/.prisma

COPY --from=build /myapp/build /myapp/build
COPY --from=build /myapp/package.json /myapp/package.json
COPY --from=build /myapp/start.sh /myapp/start.sh
COPY --from=build /myapp/prisma /myapp/prisma

ENTRYPOINT [ "./start.sh" ]
```

ì´ Dockerfileì—ì„œ TMDB_API_KEY, DATABASE_URL ê°™ì€ í™˜ê²½ ë³€ìˆ˜ë„ ì§€ì •í–ˆëŠ”ë°ìš”.

í•˜ë‚˜í•˜ë‚˜ ë”°ì ¸ë³´ë©´ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆì„ ê²ë‹ˆë‹¤.

---

## Github Actionìœ¼ë¡œ Deployí•˜ê¸°

ì´ì œ ì‹¤ì œ ë°°í¬í•´ ë³¼ê¹Œìš”?

```bash
git add .

git commit -m "prisma setting ended"

git push
```

ìœ„ì™€ ê°™ì´ í•˜ë©´ í˜„ì¬ ìƒíƒœë¡œ Githubì— Pushê°€ ë˜ë©´ì„œ ìš°ë¦¬ê°€ ì§€ë‚œ ì‹œê°„ì— ë§Œë“¤ì—ˆë˜ Github Actionì´ ì‘ë™ë˜ë©´ì„œ ìë™ìœ¼ë¡œ fly.ioì— ë°°í¬ê°€ ë˜ëŠ”ë°ìš”.

í•œì°¸ ê¸°ë‹¤ë¦¬ê³  ë‚˜ë©´ ì„±ê³µí–ˆë‹¤ê³  ë‚˜ì˜¤ëŠ”ë°ìš”.

ì´ì œ, ì‹¤ì œ ì£¼ì†Œë¡œ ì ‘ì†í•´ ë´…ì‹œë‹¤.

ê·¸ëŸ¬ë©´ ì•„ë˜ì™€ ê°™ì´ API ì—”ë“œ í¬ì¸íŠ¸ê¹Œì§€ ì •ìƒ ì‘ë™í•œë‹¤ê³  ë‚˜ì˜¬ ê²ë‹ˆë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEg_EBOo4fBR1XW82MW_LLBktAbP4gWlU2KzT8h8Ljxpg5hBhsOCIhhzEq69PvGP5JxEktwGpm7_eHgM262UADJBwqyZqdykBKQFq5lLVdx98bM98DJD6hM3SD19a6A0F9ECTgbwUdG-zGJuNzfI-s3o_6dX9cHzASugPKUCTMOlboB01E1SOnPXKrI_O_U)

![](https://blogger.googleusercontent.com/img/a/AVvXsEjptdanwxHrWtXEQlcC6KIHINM3IYF7O-ByHaWqnX_RhOz_fz2759po1BRuRbIU48FRu_BoUWGuy_aXftYmTM5TncVkVMYSQkw5FZ7sFIAnjzTTzVxs8QiaNQ9E0L_pXrzoVwi8CrZQ_vf6vu2c1x1VsJnrBkJKXZUSnkOE7shLHogSy_W947HQFiiICA4)

ì´ì œ, ì‹¤ì œ fly.io ë„ì»¤ ì´ë¯¸ì§€ê°€ ìˆëŠ” ê°€ìƒë¨¸ì‹ ìœ¼ë¡œ ssh ì ‘ì†í•´ ë³¼ê¹Œìš”?

```bash
fly ssh console
```

ssh ì ‘ì†í•˜ë©´ ìš°ë¶„íˆ¬ ì½˜ì†”ì— ì ‘ì†í•˜ê²Œ ë˜ëŠ”ë°ìš”.

ì•„ë˜ì™€ ê°™ì´ ë°ì´í„°ë¥¼ í™•ì¸í•´ ë³´ë©´ Dockerfileë¡œ ìš°ë¦¬ê°€ ì‘ì„±í–ˆë˜ ê²Œ ë‹¤ ë‚˜ì˜¬ ê²ë‹ˆë‹¤.

```bash
âœ  sveltekit-deploy-on-fly-io git:(main) âœ— fly ssh console
Connecting to fdaa:0:57cc:a7b:17c:5313:2eed:2... complete
root@e784e669a41638:/myapp# ls -al
total 28
drwxr-xr-x  5 root root 4096 Aug  7 11:53 .
drwxr-xr-x 24 root root 4096 Aug  7 12:52 ..
drwxr-xr-x  4 root root 4096 Aug  7 11:53 build
drwxr-xr-x 76 root root 4096 Aug  7 11:53 node_modules
-rw-r--r--  1 root root 1225 Aug  7 11:52 package.json
drwxr-xr-x  3 root root 4096 Aug  7 11:53 prisma
-rw-r--r--  1 root root  688 Aug  7 11:52 start.sh
root@e784e669a41638:/myapp# ls -l /data
total 44
drwx------ 2 root root 16384 Aug  7 07:21 lost+found
-rw-r--r-- 1 root root 28672 Aug  7 12:52 sqlite.db
root@e784e669a41638:/myapp# 
```

"/data" ì´ ê²½ë¡œëŠ” ìš°ë¦¬ê°€ ë§Œë“  1GBì˜ ë””ìŠ¤í¬ ìŠ¤í˜ì´ìŠ¤ë¡œ ì—¬ê¸°ì— sqlite.db íŒŒì¼ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ì‹¤ì œ ìš°ë¶„íˆ¬ ê°€ìƒ ë¨¸ì‹ ì˜ ë””ìŠ¤í¬ êµ¬ì¡°ë¥¼ ë³´ì‹œë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```bash
root@e784e669a41638:/myapp# df -h
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs         97M     0   97M   0% /dev
/dev/vda        7.8G  300M  7.1G   4% /
shm             109M     0  109M   0% /dev/shm
tmpfs           109M     0  109M   0% /sys/fs/cgroup
/dev/vdb        974M   52K  908M   1% /data
root@e784e669a41638:/myapp# 
```

ì–´ë–¤ê°€ìš”?  "/data" ë¶€ë¶„ì´ 908Më¡œ ê±°ì˜ 1GBì¸ ê²Œ í™•ì¸ë˜ì‹¤ ê²ë‹ˆë‹¤.

ê·¸ë¦¬ê³  "/" ê²½ë¡œëŠ” ìš°ë¶„íˆ¬ê°€ ì˜¬ë ¤ì ¸ ìˆëŠ” ê³³ì¸ë°ìš”.

ì´ë ‡ê²Œ DB ì €ì¥ì†Œë¥¼ ë‹¤ë¥¸ ë³¼ë¥¨ìœ¼ë¡œ í•˜ëŠ” ì´ìœ ëŠ” ì™œëƒí•˜ë©´ ìš°ë¦¬ê°€ ì•±ì„ ì—…ê·¸ë ˆì´ë“œë‚˜ ì—…ë°ì´íŠ¸í•˜ë©´ Dockerê°€ ì•±ì„ ì „ë¶€ ìƒˆë¡œ ë§Œë“¤ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ê·¸ëŸ¬ë©´ ê¸°ì¡´ì— ê°€ì§€ê³  ìˆë˜ DB ë¶€ë¶„ì„ ì „ë¶€ ì½ì–´ë²„ë¦¬ê²Œ ë˜ê¸° ë•Œë¬¸ì¸ ê±°ì£ .

"/data"ë¼ê³  ë”°ë¡œ ê°€ì§€ê³  ìˆìœ¼ë©´ Dockerì™€ ìƒê´€ì—†ì´ DBë¥¼ ìœ ì§€ ê´€ë¦¬ í•  ìˆ˜ ìˆëŠ” ê±°ì£ .

ì§€ê¸ˆê¹Œì§€ Prismaì™€ SvelteKit ê·¸ë¦¬ê³  Fly.ioì— ë°°í¬í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë´¤ëŠ”ë°ìš”.

ì´ë ‡ê²Œ ì´ 4í¸ì— ê±¸ì³ SvelteKit ì´ˆê¸° ì„¸íŒ…ì„ ê³µë¶€í–ˆëŠ”ë°ìš”.

ì´ì œ ë³¸ê²©ì ìœ¼ë¡œëŠ” í’€ ìŠ¤íƒ ì•± ê°œë°œì„ ìœ„í•œ ëª¨ë“  ì¤€ë¹„ê°€ ëë‚œ ê±° ê°™ìŠµë‹ˆë‹¤.

ê·¸ëŸ¼.

