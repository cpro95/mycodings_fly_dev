---
slug: 2024-08-03-cloudflare-hono-lucia-github-id-login-with-d-1-db
title: Cloudflare, Honoì—ì„œ Lucia Authë¥¼ ì´ìš©í•´ì„œ GitHub IDë¡œ ë¡œê·¸ì¸ êµ¬í˜„í•˜ê¸°
date: 2024-08-03T07:46:28.165Z
description: Lucia Authì™€ arctic íŒ¨í‚¤ì§€ë¥¼ ì´ìš©í•´ì„œ GitHub ID ë¡œê·¸ì¸ì„ êµ¬í˜„í•´ ë´¤ìŠµë‹ˆë‹¤.
meta:
  keywords:
    - Cloudflare
    - Hono
    - Lucia
    - Drizzle orm
    - D1 DB
    - GitHub ID
published: true
---

# Cloudflare, Honoì—ì„œ Lucia Authë¥¼ ì´ìš©í•´ì„œ GitHub IDë¡œ ë¡œê·¸ì¸ êµ¬í˜„í•˜ê¸°

ì•ˆë…•í•˜ì„¸ìš”?

ì§€ë‚œ ì‹œê°„ì—ëŠ” Cloudflare ìƒì—ì„œ D1 DBë¥¼ ì´ìš©í•˜ì—¬ Honoë¥¼ ì´ìš©í•´ì„œ ìœ ì € ë¡œê·¸ì¸ì„ êµ¬í˜„í•´ ë´¤ëŠ”ë°ìš”.

Luciaë€ Auth íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

ì´ë²ˆì—ëŠ” OAuthë¥¼ ë„ì „í•´ ë³¼ ìƒê°ì¸ë°ìš”.

Github IDë¡œ ë¡œê·¸ì¸ì„ ì‹œë„í•´ ë³´ê² ìŠµë‹ˆë‹¤.

ë‹¹ì—°íˆ Drizzle ORMì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

ë¨¼ì €, ì§€ë‚œ ì‹œê°„ ê°•ì˜ ë§í¬ì…ë‹ˆë‹¤.

- [Cloudflare, Honoì—ì„œ OAuthë¥¼ ì´ìš©í•´ì„œ ë„¤ì´ë²„ ì•„ì´ë””ë¡œ Login êµ¬í˜„í•´ ë³´ê¸°](https://mycodings.fly.dev/blog/2024-07-24-cloudflare-hono-oauth-naver-login)

- [Cloudflareì—ì„œ Honoì™€ Google OAuthë¥¼ ì´ìš©í•´ì„œ Login êµ¬í˜„í•´ ë³´ê¸°](https://mycodings.fly.dev/blog/2024-07-21-cloudflare-hono-google-login)

- [Cloudflare, Hono, OAuth, Kakao Login(ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸)](https://mycodings.fly.dev/blog/2024-07-27-cloudflare-hono-oauth-kakao-login)

- [Cloudflare, D1 DB, Hono, Lucia, Drizzle ORMì„ ì´ìš©í•œ ìœ ì € ë¡œê·¸ì¸ êµ¬í˜„](https://mycodings.fly.dev/blog/2024-08-01-cloudflare-hono-d-1-lucia-drizzle-login)

---

## í…œí”Œë¦¿ ì„¤ì¹˜

ì˜¤ëŠ˜ë„ Bunì„ ì´ìš©í•´ì„œ íŒ¨í‚¤ì§€ë¥¼ êµ¬ì„±í•˜ê² ìŠµë‹ˆë‹¤.

```sh
bunx create-hono lucia-github-oauth-test
```

ê´€ë ¨ íŒ¨í‚¤ì§€ë„ ì„¤ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.

```sh
bun add lucia drizzle-orm @lucia-auth/adapter-sqlite arctic
bun add -D drizzle-kit @types/better-sqlite3
```

ì§€ë‚œ ì‹œê°„ì— ë¹„í•´ ëŠ˜ì–´ë‚œ íŒ¨í‚¤ì§€ëŠ” ë°”ë¡œ 'arctic' íŒ¨í‚¤ì§€ì¸ë°ìš”.

Luciaì—ì„œ ì¶”ì²œí•˜ëŠ” OAuth ê´€ë ¨ íŒ¨í‚¤ì§€ì…ë‹ˆë‹¤.

ì•„ì£¼ ì‰½ê²Œ ì—¬ëŸ¬ OAuth Providerë¥¼ ì œê³µí•´ ì£¼ê³  ìˆì–´ Luciaì— ì ìš©í•˜ê¸° ì‰½ìŠµë‹ˆë‹¤.

[Arctic ê³µì‹ í™ˆí˜ì´ì§€](https://arctic.js.org/)

## D1 DB ë§Œë“¤ê¸°

D1 DBë¥¼ ë§Œë“¤ì–´ì•¼ í•˜ëŠ” ì´ìœ ê°€ ë°”ë¡œ ë¡œê·¸ì¸ í–ˆì„ ê²½ìš° ì„¸ì…˜IDë¥¼ ì„œë²„ì˜ DBì— ì €ì¥í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.

ì´ ë°©ì‹ì´ ê°€ì¥ ì•ˆì „í•œ ë¡œê·¸ì¸ ë°©ì‹ì¸ë°ìš”.

ì„¸ì…˜IDë¥¼ ì„œë²„ì— ì €ì¥í•˜ì§€ ì•Šê³  ê·¸ëƒ¥ ì¿ í‚¤ë§Œ í´ë¼ì´ì–¸íŠ¸ìª½ì— ì €ì¥í•œë‹¤ë©´ ìƒë‹¹íˆ ìœ„í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì¢€ ë” ì•ˆì „í•œ ë¡œê·¸ì¸ ì²´í‚¹ ë°©ì‹ì€ ì„œë²„ì˜ ì„¸ì…˜IDë¥¼ ë¶ˆëŸ¬ì™€ì„œ í´ë¼ì´ì–¸íŠ¸ìƒì˜ ì¿ í‚¤ì— ì €ì¥ëœ ì„¸ì…˜IDì™€ ë¹„êµí•˜ê¸° ìœ„í•¨ì´ì£ .

ì´ì œ Wranlgerë¥¼ ì´ìš©í•˜ì—¬ D1 DBë¥¼ ë§Œë“¤ì–´ì•¼í•˜ëŠ”ë°ìš”.

```sh
npx wrangler login
```

ìœ„ì™€ ê°™ì´ Cloudflareì— ë¡œê·¸ì¸í•˜ë©´ ë©ë‹ˆë‹¤.

ë¸Œë¼ìš°ì €ì—ì„œ Cloudflareì— ë¡œê·¸ì¸í•˜ë©´ ë©ë‹ˆë‹¤.

ê·¸ë¦¬ê³  ì•„ë˜ì™€ ê°™ì´ í„°ë¯¸ë„ CLIdì—ì„œ ì§ì ‘ D1 DBë¥¼ ë§Œë“­ë‹ˆë‹¤.

```sh
âœ  npx wrangler d1 create hono-lucia-test-db2

 â›…ï¸ wrangler 3.67.1 (update available 3.68.0)
-------------------------------------------------------

âœ… Successfully created DB 'hono-lucia-test-db' in region APAC
Created your new D1 database.

[[d1_databases]]
binding = "DB" # i.e. available in your Worker on env.DB
database_name = "hono-lucia-test-db2"
database_id = "f6b7477f-~~~~-~~~~-~~~~-c~~~~92538"
```

ìœ„ì—ì„œ ë³´ì‹œë©´ database_id ì´ ê°’ì´ ì•„ì£¼ ì¤‘ìš”í•œë°ìš”.

ì˜ ì €ì¥í•´ ë‘ì‹œë©´ ë©ë‹ˆë‹¤.

í˜¹ì‹œ ìŠì–´ë²„ë¦¬ë”ë¼ë„ ë‚˜ì¤‘ì— Cloudflare ëŒ€ì‹œë³´ë“œì— ê°€ë„ ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì œ ì´ ê°’ì„ wrangler.toml íŒŒì¼ì— ë„£ì–´ë‘¬ì•¼ í•©ë‹ˆë‹¤.

```sh
name = "bun-hono-drizzle-lucia-auth-test"
compatibility_date = "2024-07-28"
pages_build_output_dir = "./dist"

[[d1_databases]]
binding = "DB"
database_name = "hono-lucia-test-db2"
database_id = "f6b7477f-~~~~-~~~~-~~~~-c~~~~92538"
```

ì´ì œ 1ì°¨ ì¤€ë¹„ê°€ ëë‚¬ìŠµë‹ˆë‹¤.

## Drizzleë¡œ DB Schema ë§Œë“¤ê¸°

Drizzleë¡œ DB Schema(ìŠ¤í‚¤ë§ˆ) íŒŒì¼ì„ ë§Œë“¤ì–´ì•¼ í•˜ëŠ”ë°ìš”.

ë¨¼ì €, src í´ë”ì— dbë¼ëŠ” í´ë”ë¥¼ ë§Œë“¤ê³  ê·¸ ë°‘ì— schema.ts íŒŒì¼ì„ ì•„ë˜ì™€ ê°™ì´ ë§Œë“­ì‹œë‹¤.

```ts
import { InferSelectModel } from "drizzle-orm";
import { integer, sqliteTable, text } from "drizzle-orm/sqlite-core";
import { generateId } from "lucia";

export const usersTable = sqliteTable("users", {
  id: text("id")
    .primaryKey()
    .notNull()
    .$defaultFn(() => generateId(15)),
  github_id: text("github_id").notNull().unique(),
  username: text("username").notNull(),
});

export type SelectUser = InferSelectModel<typeof usersTable>;

export const sessionsTable = sqliteTable("sessions", {
  id: text("id").primaryKey().notNull(),
  user_id: text("user_id")
    .notNull()
    .references(() => usersTable.id),
  expires_at: integer("expires_at").notNull(),
});

export type MySessionsType = InferSelectModel<typeof sessionsTable>;
```

Github IDë¥¼ ì´ìš©í•œ ë¡œê·¸ì¸ì—ì„œ ìš°ë¦¬ê°€ Github ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ë ¤ê³  í•˜ëŠ”ê±´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.

ë‹¨ì§€ github_idì™€ username ì •ë„ë§Œ ê°€ì ¸ì˜¤ë ¤ê³  í•©ë‹ˆë‹¤.

ê·¸ë˜ì„œ usersTableì— ê·¸ë ‡ê²Œ ì„¤ì •í–ˆê³ ìš”.

ê·¸ë¦¬ê³  ë¡œê·¸ì¸ ì„¸ì…˜ì„ ì €ì¥í•˜ê¸° ìœ„í•´ì„œë„ í…Œì´ë¸”ì„ ë§Œë“¤ì–´ì•¼ í•˜ëŠ”ë°ìš”.

ë°”ë¡œ sessionsTableì…ë‹ˆë‹¤.

ì„¸ì…˜ í…Œì´ë¸”ì€ ê°„ë‹¨í•˜ê²Œ ìœ ì € ì•„ì´ë”” ì •ë³´ì™€ ë§Œë£Œ ì •ë³´ë§Œ ì €ì¥í•˜ë©´ ë©ë‹ˆë‹¤.

sessionsTableì˜ ìœ ì € ì•„ì´ë”” ì •ë³´ì¸ user_id ì»¬ëŸ¼ì€ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì´ìš©í•´ì„œ usersTable.idì™€ ì—°ê²°ë˜ì–´ ìˆëŠ”ê±° ë³¼ ìˆ˜ ìˆì„ ê²ë‹ˆë‹¤.

ê·¸ë¦¬ê³  Drizzle ORMì´ ì¢‹ì€ê²Œ í…Œì´ë¸”ì˜ íƒ€ì…ì •ë³´ë¥¼ ì‰½ê²Œ êµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

InferSelectModelë¡œ ì•„ì£¼ ì‰½ê²Œ íƒ€ì… ì •ë³´ë¥¼ êµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì œ DBë¥¼ ìœ„í•œ ìŠ¤í‚¤ë§ˆ íŒŒì¼ì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë©´ drizzle-kit íŒ¨í‚¤ì§€ë¡œ ì‹¤ì œ SQL íŒŒì¼ë¡œ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.

ì´ì œ drizzle.config.ts íŒŒì¼ì„ ë§Œë“¤ì–´ì•¼ í•˜ëŠ”ë°ìš”.

ì´ê±¸ ë§Œë“¤ê¸° ì‹«ìœ¼ë©´ ê·¸ëƒ¥ ëª…ë ¹ì–´ìƒì— ì­‰ ë‚˜ì—´í•˜ë©´ ë˜ëŠ”ë°, drizzle-kitì—ì„œëŠ” `drizzle.config.ts` íŒŒì¼ì„ ê¶Œê³ í•˜ê³  ìˆìŠµë‹ˆë‹¤.

```ts
import { defineConfig } from "drizzle-kit";
export default defineConfig({
  dialect: "sqlite",
  schema: "./src/db/schema.ts",
  out: "./drizzle",
});
```

ì´ì œ í„°ë¯¸ë„ìƒì—ì„œ drizzle-kitìœ¼ë¡œ SQL íŒŒì¼ì„ generate í•˜ê² ìŠµë‹ˆë‹¤.

```sh
âœ  npx drizzle-kit generate
No config path provided, using default 'drizzle.config.ts'
Reading config file '/Users/22222/Codings/Javascript/hono/bun-hono-cloudflare-d1-drizzle-lucia-github-oauth-test/drizzle.config.ts'
2 tables
sessions 3 columns 0 indexes 1 fks
users 3 columns 1 indexes 0 fks

[âœ“] Your SQL migration file âœ drizzle/0000_whole_energizer.sql ğŸš€
```

ì‹¤í–‰ê²°ê³¼ drizzle í´ë” ë°‘ì— sql íŒŒì¼ì´ ìƒê²¼ìŠµë‹ˆë‹¤.

í•œë²ˆ ì—´ì–´ë³´ê² ìŠµë‹ˆë‹¤.

```sql
CREATE TABLE `sessions` (
	`id` text PRIMARY KEY NOT NULL,
	`user_id` text NOT NULL,
	`expires_at` integer NOT NULL,
	FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON UPDATE no action ON DELETE no action
);
--> statement-breakpoint
CREATE TABLE `users` (
	`id` text PRIMARY KEY NOT NULL,
	`github_id` text NOT NULL,
	`username` text NOT NULL
);
--> statement-breakpoint
CREATE UNIQUE INDEX `users_github_id_unique` ON `users` (`github_id`);
```

Drizzle ORMìœ¼ë¡œ ë§Œë“¤ì—ˆë˜ sessions, users í…Œì´ë¸”ì´ ë§Œë“¤ì–´ì¡Œë„¤ìš”.

ì´ì œ ì´ sql íŒŒì¼ì„ ì´ìš©í•´ì„œ ì‹¤ì œ DBì— migrate(ì´ë™) í•´ì•¼ í•©ë‹ˆë‹¤.

ë¨¼ì €, ê°œë°œ ì„œë²„ë¥¼ ìœ„í•´ wrangler ë¡œì»¬ íŒŒì¼ìª½ì— migrate í•˜ê² ìŠµë‹ˆë‹¤.

```sh
âœ  npx wrangler d1 execute hono-lucia-test-db2 --local --file=./drizzle/0000_whole_energizer.sql


 â›…ï¸ wrangler 3.68.0
-------------------

ğŸŒ€ Executing on local database hono-lucia-test-db2 (a5d0f59b-3b77-43bc-8b35-e942b43b7fa8) from .wrangler/state/v3/d1:
ğŸŒ€ To execute on your remote database, add a --remote flag to your wrangler command.
```

ê·¸ë¦¬ê³  Cloudflare ì„œë²„ì—ë„ migrate í•©ì‹œë‹¤.

'--local' ì˜µì…˜ì„ '--remote' ì˜µì…˜ìœ¼ë¡œ ë°”ê¿”ì£¼ë©´ ë©ë‹ˆë‹¤.

```sh
âœ  npx wrangler d1 execute hono-lucia-test-db2 --remote --file=./drizzle/0000_whole_energizer.sql

 â›…ï¸ wrangler 3.68.0
-------------------

âœ” âš ï¸ This process may take some time, during which your D1 database will be unavailable to serve queries.
  Ok to proceed? â€¦ yes
ğŸŒ€ Executing on remote database hono-lucia-test-db2 (a5d0f59b-3b77-43bc-8b35-e942b43b7fa8):
ğŸŒ€ To execute on your local development database, remove the --remote flag from your wrangler command.
Note: if the execution fails to complete, your DB will return to its original state and you can safely retry.
â”œ ğŸŒ€ Uploading a5d0f59b-3b77-43bc-8b35-e942b43b7fa8.9af0f7850c778e7a.sql
â”‚ ğŸŒ€ Uploading complete.
â”‚
ğŸŒ€ Starting import...
ğŸŒ€ Processed 3 queries.
ğŸš£ Executed 3 queries in 0.01 seconds (4 rows read, 7 rows written)
   Database is currently at bookmark 00000001-00000000-00004de1-5c27e04842c894ef99ea7ac0926907f2.
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Total queries executed â”‚ Rows read â”‚ Rows written â”‚ Database size (MB) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3                      â”‚ 4         â”‚ 7            â”‚ 0.03               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

í„°ë¯¸ë„ì°½ì— ì„±ê³µë©”ì‹œì§€ê°€ ëœ°ê²ë‹ˆë‹¤.

Cloudflare ëŒ€ì‹œë³´ë“œì— ê°€ì„œ í™•ì¸í•´ ë³´ë©´ ì˜ ë‚˜ì™€ ìˆì„ ê²ë‹ˆë‹¤.

---

## Lucia ì„¤ì •

Lucia Authë¥¼ ì´ìš©í•˜ë ¤ë©´ Luciaë¥¼ ì´ˆê¸°í™”í•´ì•¼ í•˜ëŠ”ë°ìš”.

src í´ë” ë°‘ì˜ db í´ë”ì— lucia.ts íŒŒì¼ì„ ì•„ë˜ì™€ ê°™ì´ ë§Œë“­ì‹œë‹¤.

```ts
import { D1Adapter } from "@lucia-auth/adapter-sqlite";
import { Lucia } from "lucia";
import { SelectUser } from "./schema";

export function initializeLucia(D1: D1Database) {
  const adapter = new D1Adapter(D1, {
    user: "users",
    session: "sessions",
  });

  return new Lucia(adapter, {
    sessionCookie: {
      attributes: {
        secure: process.env.NODE_ENV === "production",
      },
    },
    getUserAttributes: (attributes) => {
      return {
        github_id: attributes.github_id,
        username: attributes.username,
      };
    },
  });
}

declare module "lucia" {
  interface Register {
    Lucia: ReturnType<typeof initializeLucia>;
    DatabaseUserAttributes: Omit<SelectUser, "id">;
  }
}
```

ì˜ˆì „ì— ë°°ì› ë˜ Lucia ì´ˆê¸°íŒŒì¼ì—ì„œ ë­”ê°€ê°€ ì¶”ê°€ëëŠ”ë°ìš”.

sessionCookie ë¶€ë¶„ì— secureë€ì€ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³  getUserAttributesì—ì„œëŠ” githubIdì™€ usernameì„ ì§€ì •í•´ì„œ ë‚˜ì¤‘ì— ì„¸ì…˜ì„ ì´ìš©í•´ì„œ ì‰½ê²Œ ì´ ë‘ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì œ ë§Œë°˜ì˜ ì¤€ë¹„ê°€ ëë‚¬ìŠµë‹ˆë‹¤.

---

## Githubì—ì„œ ê´€ë ¨ ì •ë³´ ì–»ê¸°

Github ì‚¬ì´íŠ¸ì—ì„œ Settingsì—ì„œ ì™¼ìª½ ë§¨ ë°‘ì— ë³´ë©´ "Developer Settings"ì´ ìˆìŠµë‹ˆë‹¤.

ë§í¬ëŠ” ì—¬ê¸° [https://github.com/settings/apps](https://github.com/settings/apps) ì…ë‹ˆë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEh0XHXUiGsZeM_JC5cdNYN0sAMeWLxc5Jr0z-cLSlnIwPcsPfQTpvsm_7X3v5BBA2imdUM7T5m-cLzTPcljMC_9pmxvDFroPqwC2oJJIbJaewWrGjrJJPJSSroxDyvfxAjBARcEpfxNGr7nutyt2a8kDphm9BRk_ppS1MnTEpiFKlqvfS1TMTh_WIEBbDU)

ìœ„ì™€ ê°™ì€ í™”ë©´ì—ì„œ ì˜¤ë¥¸ìª½ì— "New GitHub App" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë©ë‹ˆë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEi9iIJ1foQJ8wtQkWfb_0kuL-T_hHPtzVQNl8yC4-Ocj_AUHJ47zLGOf97oq89zq2G2xCdD4amkWIBsFEAoE8e5-Hs7oS0RZCbdq2NG6R7FxnMET8eCMpFZcd1LKGuO2MypGOU4hlca9tZMJh5SJ1vgSNGdLPhKQcAnlIPcrpCbjaYdSiQitx1v7eDRKnY)

ìœ„ì™€ ê°™ì´ ë‚˜ì˜¤ëŠ”ë° ì ë‹¹í•˜ê²Œ ë„£ì–´ì£¼ë©´ ë©ë‹ˆë‹¤.

ì¤‘ìš”í•œê±´ "Homepage URL"ê³¼ "Callback URL"ì…ë‹ˆë‹¤.

ì´ë²ˆì—ëŠ” ì½œë°± URLì„ ì¡°ê¸ˆ ê¸¸ê²Œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

`http://localhost:5173/admin/login/github/callback`

![](https://blogger.googleusercontent.com/img/a/AVvXsEiR75vPvmczVzYHVlWwYBkVQP7tHnMnBqADTRkHEQ4WzCNY0YtLhWoGUi4EKtDgZMI4caWNPer0ziZUY-w1cHTruYN5jT0V-8G7Arflq2B9tJt2fGG8AIuHVorfrYXI8xxgHxIRnepcV-fz8TIrEL7fHMJ4kJLEe1Z7kxrEJBz6Z3eyF_MvDg3X0Jje4iI)

ê·¸ë¦¬ê³  í™”ë©´ì„ ìŠ¤í¬ë¡¤í•˜ì…”ì„œ WebHook ìª½ì´ ë‚˜ì˜¤ëŠ”ë° ì´ê±´ ì–¸ì²´í¬í•˜ì‹­ì‹œìš”.

í•„ìš”í•˜ì‹¤ ë•Œ í•˜ë©´ ë©ë‹ˆë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEi0Adv3nJ02oeUBE569zGSSZGY9Tv9MdJExttMylazRUXNVtZi3wbD-kbtAEaXeMF2ZhS9goWT7-JSJqrNR9fkNVf5Q_ciBcZNox974jkFUQn06kdgk-tkCr68l07sZaohzgWIq-bEHa1Jzr9sjY17EfdGesZQbYbonUjMXqP3-f80fSgjwzIjzzuszBN8)

ì´ì œ ìœ„ì™€ ê°™ì´ "Create ~~~"ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë©ë‹ˆë‹¤.

ê·¸ëŸ¬ë©´ ì•„ë˜ì™€ ê°™ì´ Client IDì™€ Client Secretsë¥¼ êµ¬í•˜ëŠ” í™”ë©´ì´ ë‚˜ì˜¤ëŠ”ë°, IDëŠ” ìë™ ìƒì„±ë˜ê³  SecretsëŠ” ë§Œë“¤ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë‚˜ì˜µë‹ˆë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEjW1-HPrbKRFngXNDxLCPMQcPHmiLqk1ApTOWVwzqJEC2DqB_kq67sL7bm2jw4CO9saCm1y4R8CgFKHPPhNITrucRz5FYuhnK555c6XgYpoowKhq25l5Zv_mn3AxLARCX5IHVRl4K1_hlTA595pLV68RFYjW04ee4q57lcEarAM2lFdNIEhhCsJOL4tTa4)

SecretsëŠ” í™”ë©´ì— í•œë²ˆ ë‚˜ì˜¤ê¸° ë•Œë¬¸ì— ê¼­ ë‹¤ë¥¸ê³³ì— ì €ì¥í•´ ë†”ì•¼ í•©ë‹ˆë‹¤.

ì•ˆ ê·¸ëŸ¬ë©´ ì§€ìš°ê³  ë‹¤ì‹œ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.

ì´ì œ GitHub IDë¡œ ë¡œê·¸ì¸í•˜ê¸° ìœ„í•œ ì¤€ë¹„ê°€ ëë‚¬ìŠµë‹ˆë‹¤.

---

## Admin ë¼ìš°íŒ… ë§Œë“¤ê¸°

'index.tsx' íŒŒì¼ì€ ë¡œê·¸ì¸ ì—¬ë¶€ ì—†ì´ ë³´ì´ëŠ” í™”ë©´ìœ¼ë¡œ ë§Œë“¤ê³ , "/admin" ë¼ìš°íŒ…ìœ¼ë¡œ ë¡œê·¸ì¸ ê´€ë ¨ ì¸ì¦ í™”ë©´ì„ ë§Œë“¤ë ¤ê³  í•©ë‹ˆë‹¤.

'admin.tsx' íŒŒì¼ì„ ë§Œë“¤ê³  Cloudflare ê´€ë ¨ ë°”ì¸ë”©ë„ ê°™ì´ ë„£ì–´ì¤ì‹œë‹¤.

'admin.tsx' íŒŒì¼ì€ 'index.tsx' íŒŒì¼ê³¼ ê°™ì€ ìœ„ì¹˜ì— ë†“ìœ¼ë©´ ë©ë‹ˆë‹¤.

```ts
import { Hono } from "hono";
import { renderer } from "./renderer";
import { Session, User } from "lucia";
import { csrf } from "hono/csrf";

type Bindings = {
  DB: D1Database;
};

type Variables = {
  user: User | null;
  session: Session | null;
};

const admin = new Hono<{ Bindings: Bindings; Variables: Variables }>();

admin.use(csrf());

admin.use(renderer);

admin.get("/", (c) => {
  return c.render(<h1>This is Admin Page!</h1>);
});

export default admin;
```

ì´ì œ Admin ë¼ìš°íŒ…ì„ 'index.tsx' íŒŒì¼ì—ì„œ ë¼ìš°íŒ… ë“±ë¡ì„ í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.

```ts
import { Hono } from "hono";
import { renderer } from "./renderer";

// admin ë¶ˆëŸ¬ì˜¤ê¸°
import admin from "./admin";

const app = new Hono();

app.use(renderer);

app.get("/", (c) => {
  return c.render(<h1>Hello!</h1>);
});

// ì•„ë˜ê°€ ë°”ë¡œ app ë°‘ì— admin ë¼ìš°íŒ…ì„ ì¶”ê°€í•˜ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤.
app.route("/admin", admin);

export default app;
```

ì´ì œ ê°œë°œ ì„œë²„ë¥¼ ëŒë ¤ì„œ ë¸Œë¼ìš°ì €ì—ì„œ ì•„ë˜ ì£¼ì†Œë¡œ ê°€ì‹œë©´ ì›¹ì•±ì´ ì•„ë˜ì™€ ê°™ì´ ë³´ì¼ê²ë‹ˆë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEj3UzqCLqbWN0Gzf_SJk46qJQUaVHiSD-8-KXssVFGwpHWA0MoMf2r_7k0MtKoSMCpGI4-XbLt4eXrI-O5h2xcxLK23SpTeAkZDLlynvQUWGqWxzVf5Z1rr67LBWewXBCXrjWLWkFTGxMddm6MGABxeRq8Xdy25Ly8Z1nOMwnoD2jgg_xmjdU-sJzENpvo)

---

## Cloudflareì—ì„œ SECRETS ë‹¤ë£¨ê¸°

Cloudflareì—ì„œ Gitì— ì»¤ë°‹í•˜ì§€ ì•ŠëŠ” ë°ì´í„°ëŠ” 'vars'ë¼ëŠ” í•­ëª©ìœ¼ë¡œ ê´€ë¦¬í•´ì¤ë‹ˆë‹¤

ë³´í†µ Next.js ì•±ì—ì„œ '.env' íŒŒì¼ì— ë„£ì—ˆë˜ê±°ë‘ ê°™ë‹¤ê³  ë³´ì‹œë©´ ë˜ëŠ”ë°ìš”.

wrangler.toml íŒŒì¼ì— ì•„ë˜ì™€ ê°™ì´ ë¨¼ì €, GITHUB_CLIENT_IDë¥¼ ë„£ì–´ë´…ì‹œë‹¤.

```toml
[vars]
GITHUB_CLIENT_ID = "Iv~~~~~~~~~urvAVf9e8"
```

ì´ì œ Cloudflare+Honoì—ì„œ Honoì˜ Contextì—ì„œ ìœ„ GITHUB_CLIENT_IDë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë©´ ë¹„ë°€ í…ìŠ¤íŠ¸ì¸ GITHUB_CLIENT_SECRETëŠ” '.dev.vars' íŒŒì¼ì„ ë§Œë“¤ê³  ê·¸ ë°‘ì— ì•„ë˜ì™€ ê°™ì´ ë„£ì–´ë‘¡ì‹œë‹¤.

```sh
GITHUB_CLIENT_SECRET=134be63~~~~~~~~~~~~~~b52af9255af5e321
```

ì´ì œ ë‹¤ì‹œ ìœ„ì™€ ê°™ì´ ë§Œë“  Varialbesë¥¼ ì‚¬ìš©í•˜ê¸° admin.tsx íŒŒì¼ì—ì„œ ë°”ì¸ë”©ì„ ì•„ë˜ì™€ ê°™ì´ ë°”ê¾¸ê² ìŠµë‹ˆë‹¤.

```ts
type Bindings = {
  DB: D1Database;
  GITHUB_CLIENT_ID: string;
  GITHUB_CLIENT_SECRET: string;
};
```

ìœ„ì™€ ê°™ì´ ë°”ê¿¨ìœ¼ë©´ ì´ì œ Honoì˜ Contextì¸ c.env.GITHUB_CLIENT_ID ì™€ ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ts
admin.get("/", (c) => {
  console.log(c.env.GITHUB_CLIENT_ID);
  console.log(c.env.GITHUB_CLIENT_SECRET);

  return c.render(<h1>This is Admin Page!</h1>);
});
```

ìœ„ì™€ ê°™ì´ í•˜ë©´ ì½˜ì†”ì°½ì— GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRETê°€ ê°ê° ë‚˜íƒ€ë‚ ê²ë‹ˆë‹¤.

ê·¸ë¦¬ê³  ë°°í¬í•  ë•ŒëŠ” Cloudflare ì„¸íŒ…í™”ë©´ì—ì„œ í™˜ê²½ë³€ìˆ˜ë¥¼ ì±…ì •í•´ ì£¼ë©´ ë©ë‹ˆë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEhw0YbkJtSJAVAHxgDMOOgNsoC-XDFW0WW7rOT35xywLEmo_HVRgjAY7BpFfMuQ-TvUDNDRpwuCejD1ijErC7Nw1tnzsGA2AfPs7tgINoqxXQ-piaPL1qoFO_Rqt2H5T-6dbzV9ZhnM_cPpxfV25ImkuLSfOB3Iir64IcYRUJQokOrkH2EokLfQO8BA2jM)

ì´ì œ ë³¸ê²©ì ì¸ ë¡œê·¸ì¸ ë¼ìš°íŒ…ì„ êµ¬í˜„í•´ ë³´ê² ìŠµë‹ˆë‹¤.

í¸ì˜ë¥¼ ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ ë§í¬ë¥¼ ë§Œë“¤ì–´ ë‘ê² ìŠµë‹ˆë‹¤.

```ts
admin.get("/", (c) => {
  return c.render(
    <>
      <h1>This is Admin Page!</h1>
      <br />
      <a href="/admin/login">Go to Login</a>
    </>
  );
});

admin.get("/login", (c) => {
  return c.render(
    <>
      <a href="/admin/login/github">GitHub ID Login</a>
    </>
  );
});
```

ì´ì œ '/admin/login' ì£¼ì†Œì—ì„œ GitHub ID Login ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ "/admin/login/github' ì£¼ì†Œë¡œ ì´ë™í•˜ê²Œ ë©ë‹ˆë‹¤.

ì´ ì£¼ì†Œì— GitHub ê´€ë ¨ ì½”ë“œë¥¼ ë„£ìœ¼ë©´ ë˜ëŠ”ë°ìš”.

ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•©ì‹œë‹¤.

```ts
import { Hono } from "hono";
import { renderer } from "./renderer";
import { Session, User } from "lucia";
import { csrf } from "hono/csrf";
import { generateState, GitHub } from "arctic";
import { setCookie } from "hono/cookie";

...
... ì´ì „ ì½”ë“œì™€ ë™ì¼
...

admin.get("/login/github", async (c) => {
  const github = new GitHub(c.env.GITHUB_CLIENT_ID, c.env.GITHUB_CLIENT_SECRET);

  const state = generateState();
  const url = await github.createAuthorizationURL(state);

  setCookie(c, "github_oauth_state", state, {
    path: "/",
    secure: process.env.NODE_ENV === "production",
    httpOnly: true,
    maxAge: 60 * 10,
    sameSite: "Lax",
  });

  console.log(url);
  return c.redirect(url.toString());
});

export default admin;

```

ì˜ˆì „ì—ëŠ” ì•„ë˜ì™€ ê°™ì´ ì§ì ‘ github authorize ì£¼ì†Œì— íŒŒë¼ë¯¸í„°ë¥¼ ì§€ì •í•´ì„œ ì•„ë˜ì™€ ê°™ì´ redirect í–ˆì—ˆëŠ”ë°ìš”.

```ts
const AUTH_ENDPOINT = "https://github.com/login/oauth/authorize";
  const params = {
    client_id: GITHUB_CLIENT_ID,
    response_type: "code",
    scope: "profile",
    redirect_uri: REDIRECT_URI,
  };
  return c.redirect(`${AUTH_ENDPOINT}?${new URLSearchParams(params)}`);
```

ë‹¤í–‰íˆ arctic íŒ¨í‚¤ì§€ì—ì„œ ìœ„ì™€ ê°™ì´ í¸í•˜ê²Œ AUTH_ENDPOINT ì£¼ì†Œë¥¼ ë¦¬í„´í•´ ì¤ë‹ˆë‹¤.

ìœ„ì—ì„œ ì œê°€ console.log(url) ì½”ë“œë¥¼ ë„£ì—ˆëŠ”ë°ìš”.

ì£¼ì†Œë¥¼ í´ë¦­í•˜ë©´ í„°ë¯¸ë„ì— ì•„ë˜ì™€ ê°™ì€ ë‚´ìš©ì´ ì¶œë ¥ë  ê²ë‹ˆë‹¤.

```sh
URL {
  href: 'https://github.com/login/oauth/authorize?response_type=code&client_id=I~~~~~~~uurvAVf9e8&state=1lboMkBZkYfV2oLJol4onxAq4vWEVL4thkoKo38n7HU',
  origin: 'https://github.com',
  protocol: 'https:',
  username: '',
  password: '',
  host: 'github.com',
  hostname: 'github.com',
  port: '',
  pathname: '/login/oauth/authorize',
  search: '?response_type=code&client_id=I~~~~~~~uurvAVf9e8&state=1lboMkBZkYfV2oLJol4onxAq4vWEVL4thkoKo38n7HU',
  searchParams: URLSearchParams {
    'response_type' => 'code',
    'client_id' => 'I~~~~~~~uurvAVf9e8',
    'state' => '1lboMkBZkYfV2oLJol4onxAq4vWEVL4thkoKo38n7HU' },
  hash: ''
}
```

ì˜ ë³´ì‹œë©´ ì˜ˆì „ì— arctic ì—†ì´ ì‘ì„±í–ˆë˜ 'response_type', 'client_id', ê·¸ë¦¬ê³  'state' ê°’ë„ ì•Œì•„ì„œ ì‘ì„±í•´ ì¤ë‹ˆë‹¤.

ê·¸ë¦¬ê³  ë¸Œë¼ìš°ì €ë¥¼ ë³´ì‹œë©´ ì•„ë˜ ê·¸ë¦¼ì²˜ëŸ¼ ë°”ë€ŒëŠ”ë°ìš”.

![](https://blogger.googleusercontent.com/img/a/AVvXsEhuZEiiJHJkLcbelXkLqTxrwf608FH0vBv5_SzurcC-x_t1RzzIO8IPx6ixHcQ-5DX-SsMiJAlda-ywKR_bSxUvE1Sptfawuv2sPyzQLdCpWK7CgPisr8L7d3dXdgDs_qJ_T-A28YqMiLjDqCxAUE0NaX6GkZdbF6dxNf_uPe_tbPGhjR2oCVPh3lBwGOo)

ìš°ë¦¬ê°€ GitHub ë””ë²¨ë¡œí¼ ì„¸íŒ…ì—ì„œ ë§Œë“¤ì—ˆë˜ GitHub ì•±ì´ ë‚˜ì˜µë‹ˆë‹¤.

Authorize ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì´ì œ ë¡œê·¸ì¸í•˜ê²Œ ë˜ëŠ”ë°ìš”.

ì €ëŠ” Github ì‚¬ì´íŠ¸ì— ë¡œê·¸ì¸ë˜ì–´ ìˆì–´ ìë™ìœ¼ë¡œ ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì´ ë‚˜ì˜µë‹ˆë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEhPsjfzHARVxEUHB6KMx-rK_SXCgSc7DJN0gUGwt_hRoZlXY0sVrvW900VaJ464SByoXeP4uKryGOLk6WSmeVHZdc_3SOw9FG6t_k1czfBiZ2dzN-BTothCd5JFUlxKXjBr7eBQysjkB9HhoSfwcinrBeIvl1JIYgrhnljuDXBvuCwVrxImOCJmz9lJwBc)

ìœ„ ê·¸ë¦¼ì€ ì§€ê¸ˆê¹Œì§€ ë°°ì› ë˜ ê±°ë‘ ë˜‘ê°™ìŠµë‹ˆë‹¤.

Githubì—ì„œ ë¡œê·¸ì¸ ì •ë³´ê°€ ë§ì•„ì„œ ìš°ë¦¬ê°€ ì§€ì •í–ˆë˜ ì½œë°±ì£¼ì†Œë¡œ ê´€ë ¨ ì •ë³´ê°’ì€ query ê°’ìœ¼ë¡œ ë˜ëŒë ¤ ì¤€ê²ë‹ˆë‹¤.

```sh
http://localhost:5173/admin/login/github/callback?code=0ad7bdf578fcacd9566c&state=1lboMkBZkYfV2oLJol4onxAq4vWEVL4thkoKo38n7HU
```

ìœ„ì™€ ê°™ì´ ë‚˜ì˜¤ëŠ”ë°ìš”.

code ê°’ì€ ë‚˜ì¤‘ì— í† í°ì„ êµ¬í•˜ê¸° ìœ„í•œ ê°€ì¥ ì¤‘ìš”í•œ ê°’ì…ë‹ˆë‹¤.

ê·¸ë¦¬ê³  state ê°’ì€ URL í•˜ì´ì¬í‚¹ì„ ë§‰ê¸° ìœ„í•´ ë¡œì»¬ìƒíƒœì—ì„œ ë§Œë“¤ì—ˆê³ , ê·¸ state ê°’ì€ ì¿ í‚¤ë¡œ ë¸Œë¼ìš°ì €ì— ì €ì¥í•´ ë†“ì•˜ìŠµë‹ˆë‹¤.

ì‹¤ì œë¡œ í¬ë¡¬ ê°œë°œì°½ì—ì„œ 'Application' ë¶€ë¶„ì—ì„œ ì¿ í‚¤ë€ì„ ë³´ì‹œë©´ ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì´ ì €ì¥ë˜ì–´ ìˆì„ê²ë‹ˆë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEh2Rfnwa6t_pLL_AjDdHmSXf6zMb6xXnwj4Biej2XLj5zwXeIBkcQOupK9KrSVQKF4PCsMxFY4ZG18KwZpKeNp0SlVnBHKgWH6dGssqpq9UXFYeJRXe0oR2qtMpD9UQughFTaDkglwKgeAy2J7Bo5lr68dY7DmkTHFZaWuxam-jUbhMMZNXJwjOJ6eUxEg)

ëª¨ë“ ê²Œ ì œëŒ€ë¡œ ì‘ë™ë˜ê³  ìˆë„¤ìš”.

---

## GitHub ì‚¬ìš©ì ì •ë³´ ì–»ê¸°

ì´ì œ ì½œë°±ì£¼ì†Œê¹Œì§€ ë°›ì•˜ìœ¼ë‹ˆê¹Œ ì´ ì½œë°±ì£¼ì†Œì— í•´ë‹¹í•˜ëŠ” ë¼ìš°íŒ…ì—ì„œ ì•¡ì„¸ìŠ¤ í† í°ì„ ì–»ê³ , ì´ë ‡ê²Œ ì–»ì€ ì•¡ì„¸ìŠ¤ í† í°ìœ¼ë¡œ ìœ ì € ì •ë³´ë¥¼ ì–»ìœ¼ë©´ ëì…ë‹ˆë‹¤.

'code', 'state' ê°’ì˜ ê²€ì¦ì„ ìœ„í•´ Honoì—ì„œ ì¶”ì²œí•˜ëŠ” zodì™€ zValidator íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.

```sh
bun add zod @hono/zod-validator
```

ì´ì œ ë³¸ê²©ì ì¸ ì½œë°±ì£¼ì†Œì— ëŒ€ì‘í•˜ëŠ” ë¼ìš°íŒ…ì„ ë§Œë“¤ê² ìŠµë‹ˆë‹¤.

```ts
admin.get(
  "/login/github/callback",
  zValidator(
    "query",
    z.object({
      code: z.string(),
      state: z.string(),
    })
  ),
  async (c) => {
    const github = new GitHub(
      c.env.GITHUB_CLIENT_ID,
      c.env.GITHUB_CLIENT_SECRET
    );

    const { code, state } = c.req.valid("query");
    const storedState = getCookie(c).github_oauth_state ?? null;

    if (!code || !state || !storedState || state !== storedState) {
      return c.body(null, 400);
    }

    try {
      const tokens = await github.validateAuthorizationCode(code);
      console.log(tokens);

      const githubUserResponse = await fetch("https://api.github.com/user", {
        headers: {
          Authorization: `Bearer ${tokens.accessToken}`,
        },
      });
      const githubUser = await githubUserResponse.json();
      console.log(githubUser);
      
    } catch (e) {
      if (
        e instanceof OAuth2RequestError &&
        e.message === "bad_verification_code"
      ) {
        // invalid code
        return c.body(null, 400);
      }
      return c.body(null, 500);
    }

    return c.redirect("/admin");
  }
);
```

ìœ„ ì½”ë“œë¥¼ ë³´ì‹œë©´ ë¨¼ì €, queryì—ì„œ code, state ê°’ì„ ì–»ì–´ì˜¤ê³ , ê·¸ë¦¬ê³  ì¿ í‚¤ì—ì„œ storedStateì™€ state ê°’ì„ ë¹„êµí•´ì„œ í‹€ë¦¬ë©´ ì—ëŸ¬ë¥¼ ëƒ…ë‹ˆë‹¤.

ì—ëŸ¬ê°€ ì—†ìœ¼ë©´ ì´ì œ try~catch ë¬¸ì„ í†µí•´ githubì—ì„œ ìœ ì € ì •ë³´ë¥¼ ì–»ì–´ì˜¤ëŠ” APIì— ì ‘ê·¼í•´ì„œ githubUser ì •ë³´ë¥¼ ì–»ì–´ì˜¤ë©´ ë©ë‹ˆë‹¤.

ì´ githubUser ì •ë³´ë¥¼ ì–»ê¸° ìœ„í•´ì„œëŠ” ë‹¹ì—°íˆ ì•¡ì„¸ìŠ¤ í† í°ì„ êµ¬í•´ì•¼ í•˜ëŠ”ë°ìš”.

ì´ ë•Œ arctic íŒ¨í‚¤ì§€ê°€ ì œê³µí•´ì£¼ëŠ” validateAuthorizationCode í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ ì‰½ê²Œ êµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì œ ë¸Œë¼ìš°ì €ì—ì„œ ë¡œê·¸ì¸ì„ ì‹¤í–‰í•´ ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ ì½˜ì†”ì°½ì— ì•¡ì„¸ìŠ½í† í°í•˜ê³ , ìœ ì € ì •ë³´ê°€ ë‚˜ì˜¤ëŠ”ë°ìš”.

ì•„ë˜ ì½˜ì†”ì°½ì„ ë³´ì‹œë©´ ìœ ì € ì •ë³´ê°€ ë„ˆë¬´ ê¸¸ê²Œ ë‚˜ì˜µë‹ˆë‹¤.

ìš°ë¦¬ê°€ í•„ìš”ë¡œí•˜ëŠ” ê±°ëŠ” github_idì™€ usernameì´ë‹ˆê¹Œ ì•„ë˜ ì •ë³´ì—ì„œëŠ” login, id ê°’ ë‘ê°œë§Œ í•„ìš”í•  ê±° ê°™ë„¤ìš”.

ì˜ ë³´ì‹œë©´ id ê°’ì€ íƒ€ì…ì´ numberì…ë‹ˆë‹¤.

loginì€ usernameìœ¼ë¡œ í•˜ê³ , id ê°’ì´ github_idì¸ë°, github_idëŠ” ìš°ë¦¬ê°€  string íƒ€ì…ìœ¼ë¡œ ì§€ì •í–ˆì—ˆìŠµë‹ˆë‹¤.

ë‚˜ì¤‘ì— íƒ€ì…ì„ ë°”ê¿”ì¤˜ì•¼í•˜ë‹ˆê¹Œ ì£¼ì˜í•´ì•¼í•©ë‹ˆë‹¤.

```sh
{ accessToken: 'g~~~~~~~~~~~~~~UQtMl0s5YsS' }
{
  login: '~~~~~~~~',
  id: ~~~~~, // íƒ€ì… ìœ ì˜
  node_id: 'MDQ6V~~~~~~~~wODUyNzY=',
  avatar_url: 'https://avatars.githubusercontent.com/u/~~~6?v=4',
...
...
  email: null,
  hireable: null,
  bio: null,
  twitter_username: null,
  notification_email: null,
  public_repos: 30,
  public_gists: 0,
  created_at: '2013-07-25T00:14:48Z',
  updated_at: '2024-08-03T04:40:45Z'
}
```

---

## luciaë¥¼ ì´ìš©í•œ ì„¸ì…˜ê³¼ ì¿ í‚¤ ì €ì¥í•˜ê¸°

ì´ì œ ìœ„ì™€ ê°™ì´ ë§Œë“  ìƒíƒœì—ì„œ ì¡°ê¸ˆ ë” í™•ì¥í•´ ë³´ê² ìŠµë‹ˆë‹¤.

ë¨¼ì €, ë¡œì§ì€ Github ìœ ì €ì •ë³´ë¥¼ ì–»ì–´ì„œ í•´ë‹¹ ì•„ì´ë””ê°€ ê¸°ì¡´ usersTableì— ìˆë‹¤ë©´ ê·¸ ìƒíƒœì—ì„œ luciaë¥¼ ì´ìš©í•´ì„œ ì„¸ì…˜ê³¼ ì¿ í‚¤ë¥¼ ë§Œë“¤ì–´ì£¼ê³ ,

í•´ë‹¹ ìœ ì €ê°€ usersTableì— ì—†ë‹¤ë©´ í•´ë‹¹ ìœ ì €ë¥¼ usersTableì— insert í›„ì— luciaë¥¼ ì´ìš©í•´ì„œ ì„¸ì…˜ê³¼ ì¿ í‚¤ë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” ë¡œì§ì´ í•„ìš”í•©ë‹ˆë‹¤.

ì½”ë“œê°€ ì¡°ê¸ˆ ê¸´ë° ì²œì²œíˆ ì‚´í´ë³´ì‹œë©´ ë©ë‹ˆë‹¤.

```ts
import { Hono } from "hono";
import { renderer } from "./renderer";
import { Session, User } from "lucia";
import { csrf } from "hono/csrf";
import { generateState, GitHub, OAuth2RequestError } from "arctic";
import { getCookie, setCookie } from "hono/cookie";
import { zValidator } from "@hono/zod-validator";
import { z } from "zod";
import { drizzle } from "drizzle-orm/d1";
import { usersTable } from "./db/schema";
import { eq } from "drizzle-orm";
import { initializeLucia } from "./db/lucia";

...
... ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼
...

admin.get(
  "/login/github/callback",
  zValidator(
    "query",
    z.object({
      code: z.string(),
      state: z.string(),
    })
  ),
  async (c) => {
    const github = new GitHub(
      c.env.GITHUB_CLIENT_ID,
      c.env.GITHUB_CLIENT_SECRET
    );

    const db = drizzle(c.env.DB);
    const lucia = initializeLucia(c.env.DB);

    const { code, state } = c.req.valid("query");
    const storedState = getCookie(c).github_oauth_state ?? null;

    if (!code || !state || !storedState || state !== storedState) {
      return c.body(null, 400);
    }

    try {
      const tokens = await github.validateAuthorizationCode(code);
      // console.log(tokens);

      const githubUserResponse = await fetch("https://api.github.com/user", {
        headers: {
          Authorization: `Bearer ${tokens.accessToken}`,
        },
      });
      const githubUser: any = await githubUserResponse.json();

      //githubUserì˜ id íƒ€ì…ì€ numberë¼ì„œ stringìœ¼ë¡œ íƒ€ì…ë³€í™˜í•´ì•¼ í•¨.
      const returned_github_id = githubUser.id.toString();
      const returned_username = githubUser.login;

      const existingUser = await db
        .select()
        .from(usersTable)
        .where(eq(usersTable.github_id, returned_github_id));

      if (existingUser.length !== 0) {
        const session = await lucia.createSession(existingUser[0].id, {});
        c.header(
          "Set-Cookie",
          lucia.createSessionCookie(session.id).serialize(),
          { append: true }
        );

        return c.redirect("/admin");
      }

      const user = await db
        .insert(usersTable)
        .values({ github_id: returned_github_id, username: returned_username })
        .returning();

      const session = await lucia.createSession(user[0].id, {});
      c.header(
        "Set-Cookie",
        lucia.createSessionCookie(session.id).serialize(),
        { append: true }
      );

      return c.redirect("/admin");
    } catch (e) {
      if (
        e instanceof OAuth2RequestError &&
        e.message === "bad_verification_code"
      ) {
        // invalid code
        return c.body(null, 400);
      }
      return c.body(null, 500);
    }
  }
);
```

ì´ì œ ìœ„ì™€ ê°™ì´ í•˜ë©´ ë¡œê·¸ì¸í•œ ìƒíƒœê°€ ë˜ë©´ì„œ ì¿ í‚¤ê°€ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ë˜ë©´ì„œ ë¡œê·¸ì¸ì´ ì™„ë£Œë©ë‹ˆë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEieOBNQa1SkgLx9-HTVuq0oN3AzIF06sOdxh3FwJaDbDfLE-2Yq0S-YENvHlWAK3aO5iJD1kpXYoWmniopAedftg9GrE50dVmE3av5-53orYQ7TlsDATDCvBdY3Jxsuy3vc25-RWReLN15YJbRX7-evk1pTR5x_GA82TvnViNth0dXIUA8yroc8Gir48ko)

ìœ„ì™€ ê°™ì´ ë¸Œë¼ìš°ì € ì¿ í‚¤ë¥¼ ë³´ë©´ ë‘ê°œê°€ ë‚˜ì˜¤ëŠ” ë°ìš”.

í•œê°œëŠ” lucia ì„¸ì…˜ ì¿ í‚¤ê³  í•œê°œëŠ” stateë¥¼ ì €ì¥í•œ ì¿ í‚¤ì…ë‹ˆë‹¤.

---

## Hono ë¯¸ë“¤ì›¨ì–´ë¡œ ìœ ì € ì •ë³´ì™€ ì„¸ì…˜ ì €ì¥í•˜ê¸°

ì´ì œ ë¡œê·¸ì¸ì„ í–ˆìœ¼ë©´ ë‹¤ë¥¸ ë¼ìš°íŒ…ì—ì„œ ìœ ì €ê°€ ë¡œê·¸ì¸ í•œ ìƒíƒœë¥¼ ì•Œì•„ì•¼ í•˜ëŠ”ë°ìš”.

Honoì—ì„œ ì œê³µí•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•  ê²ë‹ˆë‹¤.

ì—¬ê¸°ì„œ user, session ê°’ì„ 'c.set' ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì €ì¥í•  ê±´ë°ìš”.

ì´ë ‡ê²Œ í•˜ë©´ ì–´ë””ì„œë“ ì§€ `c.get("user")`ì™€ ê°™ì´ ì‰½ê²Œ user ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë¨¼ì €, index.tsx íŒŒì¼ê³¼ ê°™ì€ ìœ„ì¹˜ì— middleware.ts íŒŒì¼ì„ ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•©ë‹ˆë‹¤.

```ts
import { Context, Next } from "hono";
import { initializeLucia } from "./db/lucia";
import { getCookie } from "hono/cookie";

export async function authMiddleware(c: Context, next: Next) {
  const lucia = initializeLucia(c.env.DB);

  const sessionId = getCookie(c, lucia.sessionCookieName);
  if (!sessionId) {
    c.set("user", null);
    c.set("session", null);
    return next();
  }

  const { session, user } = await lucia.validateSession(sessionId);
  if (session && session.fresh) {
    c.header("Set-Cookie", lucia.createSessionCookie(session.id).serialize(), {
      append: true,
    });
  }

  if (!session) {
    c.header("Set-Cookie", lucia.createBlankSessionCookie().serialize(), {
      append: true,
    });
  }

  c.set("user", user);
  c.set("session", session);
  return next();
}
```

ë¯¸ë“¤ì›¨ì–´ëŠ” ê°„ë‹¨í•˜ê²Œ luciaì˜ validateSession í•¨ìˆ˜ë¥¼ ì´ìš©í•´ì„œ ì„¸ì…˜ user ê°’ê³¼ session ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ë¡œì§ì…ë‹ˆë‹¤.

ì´ì œ ìœ„ì—ì„œ ë§Œë“  ë¯¸ë“¤ì›¨ì–´ë¥¼ admin.tsx íŒŒì¼ì—ì„œ ë¯¸ë“¤ì›¨ì–´ ë“±ë¡ì„ í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.

admin.tsx íŒŒì¼ ìœ— ë¶€ë¶„ì— ì•„ë˜ì™€ ê°™ì´ ì½”ë“œë¥¼ ì‘ì„±í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

```ts
...
...
...

import { authMiddleware } from "./middleware";

admin.use(csrf());

admin.use(renderer);

// ë¯¸ë“¤ì›¨ì–´ ë“±ë¡í•˜ê¸°
admin.use("*", authMiddleware);

...
...
...

```

ì´ì œ admin.tsx íŒŒì¼ì˜ ëŒ€ì‹œë³´ë“œì—ì„œ ìœ ì € ë¡œê·¸ì¸í•œ ìƒíƒœì— ë”°ë¼ ë‹¤ë¥¸ í™”ë©´ì„ ë³´ì—¬ì¤ì‹œë‹¤.

```ts
admin.get("/", (c) => {
  const user = c.get("user");
  if (user) {
    return c.render(
      <>
        <h1>You are logged in as {user.id}</h1>
        <form method="POST" action="/admin/logout">
          <button type="submit">logout</button>
        </form>
      </>
    );
  }

  return c.render(
    <>
      <h1>This is Admin Page!</h1>
      <br />
      <a href="/admin/login">Go to Login</a>
    </>
  );
});
```

ìœ„ì™€ ê°™ì´ user ê°’ì´ ì¡´ì¬í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ í™”ë©´ì„ ë³´ì—¬ì£¼ë©´ ë©ë‹ˆë‹¤.

![](https://blogger.googleusercontent.com/img/a/AVvXsEiUzVfoOPaQqD2eqD-Dbf5PAc3xIjqqKKARVn8L1cc2axyjTbAV8paq8_eOLxBtuetwV80HzPCTU2AWjjSX2C3mKazOtwriYQZH7K0b9-ZbfdteC2E6aTBkB63mTN51xIqM0TdkrZzkIpcwpJVQB_4jy_f73vM8eb90Jy7TJbm0cuaz7DmZnraL_ItiCv8)

ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë¡œê·¸ì•„ì›ƒì´ ë˜ëŠ”ë°ìš”.

HTTP ë©”ì„œë“œê°€ POST ë°©ì‹ìœ¼ë¡œ í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ì œ logout ë¼ìš°íŒ…ì„ êµ¬í˜„í•´ ë´…ì‹œë‹¤.

```ts
admin.post("/logout", async (c) => {
  const lucia = initializeLucia(c.env.DB);

  const session = c.get("session");
  if (session) {
    await lucia.invalidateSession(session.id);
  }

  const cookie = lucia.createBlankSessionCookie();

  c.header("Set-Cookie", cookie.serialize(), { append: true });

  deleteCookie(c, "github_oauth_state");

  return c.redirect("/admin");
});
```

lucia.invalidateSessionì™€ lucia.createBlankSessionCookieë¥¼ ì´ìš©í•´ì„œ ì„¸ì…˜ ì¿ í‚¤ë¥¼ ì§€ì›Œì§€ê³  ìˆìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³  `deleteCookie(c, "github_oauth_state");`ë¥¼ í†µí•´ github_oauth_state ì¿ í‚¤ë„ ì‚­ì œí•´ ì£¼ê³  ìˆìŠµë‹ˆë‹¤.

ì´ë ‡ê²Œ ë˜ë©´ ë¯¸ë“¤ì›¨ì–´ì—ì„œ sessionê³¼ user ì •ë³´ë¥¼ ì–»ì§€ ëª»í•˜ê²Œ ë˜ì£ .

ì´ì œ ëì…ë‹ˆë‹¤.

Honoì™€ Github ID ë¡œê·¸ì¸ì´ ì™„ì„±ë˜ì—ˆë„¤ìš”.

ë‹¤ìŒì—ëŠ” arctic íŒ¨í‚¤ì§€ì—ì„œ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ë„ ì œê³µí•´ ì£¼ê³  ìˆì–´ ì´ê²ƒë„ í…ŒìŠ¤íŠ¸ í•´ ë³´ê² ìŠµë‹ˆë‹¤.

ê·¸ëŸ¼.
